<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TapTheMap ‚Äî Influencers Battle</title>
  <meta name="description" content="Tap your country, back your ...ght up the map. Secure by Stripe ¬∑ SSL ¬∑ Anonymous possible." />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: { fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] }, colors: { ink:{900:'#0b1020'} } } }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html,body{height:100%}
    body{background:#0b1020;color:#fff;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    #map{height:62vh;min-height:420px}
    .card{backdrop-filter:blur(8px);background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,0.12);border-radius:18px}
    .leaflet-container{background:#0b1020}
    select{color:#fff!important;background-color:rgba(255,255,255,.1)!important;border:1px solid rgba(255,255,255,.15)!important}
    select:focus{outline:none;border-color:rgba(255,255,255,.35)!important}
    select option{color:#fff;background:#0b1020}
    .badge{font-size:.75rem;color:#a3e635}
    .mini{font-variant-numeric: tabular-nums}
  </style>
</head>
<body class="bg-ink-900 text-white antialiased">
  <header class="sticky top-0 z-30">
    <div class="mx-auto max-w-7xl px-6 pt-5">
      <div class="card px-5 py-4 flex items-center justify-between">
        <a href="/" class="text-xl md:text-2xl font-bold tracking-tight">tapthemap.world</a>
        <nav class="flex items-center gap-3 text-sm text-slate-300">
          <a href="#how" class="hover:text-white">How it works</a>
          <a href="#leaders" class="hover:text-white">Leaders</a>
          <a href="#join" class="hover:text-white">Join</a>
        </nav>
      </div>
    </div>
  </header>

  <main>
    <section class="mx-auto max-w-7xl px-6">
      <div class="grid lg:grid-cols-[1fr_380px] gap-6 mt-10">
        <div>
          <div class="mb-6">
            <h1 class="text-3xl md:text-5xl font-bold leading-tight">Fill the map. Your country, your pride.</h1>
            <p class="mt-4 text-slate-300 max-w-2xl">
              Tap your country and choose 5 / 20 / 50 / 100 ‚Ç¨ or ‚ÄúOther‚Äù.
              Every contribution lights up your land.
              <span class="text-slate-200">Secure by Stripe ¬∑ SSL ¬∑ Anonymous option.</span>
            </p>
            <div class="mt-5 flex items-center gap-3 text-slate-300 text-sm">
              <span class="inline-flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
                <span>Live</span>
              </span>
              <span class="opacity-70">¬∑</span>
              <span>World heat updates every 20 s</span>
            </div>
          </div>

          <div class="grid sm:grid-cols-[1fr_auto] gap-4 items-start">
            <div class="card p-4">
              <div class="flex flex-wrap items-center gap-3">
                <label for="countrySelect" class="text-sm opacity-80">Country</label>
                <select id="countrySelect" class="rounded-lg px-3 py-2">
                  <option value="HRV|Croatia">Croatia (HRV)</option>
                </select>
                <div class="flex items-center gap-2 ml-auto">
                  <button data-amt="5" class="amt btn px-3 py-1.5 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10">‚Ç¨5</button>
                  <button data-amt="20" class="amt btn px-3 py-1.5 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10">‚Ç¨20</button>
                  <button data-amt="50" class="amt btn px-3 py-1.5 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10">‚Ç¨50</button>
                  <button data-amt="100" class="amt btn px-3 py-1.5 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10">‚Ç¨100</button>
                  <div class="flex items-center gap-2">
                    <span class="opacity-70">Other</span>
                    <input id="amtInput" type="number" min="1" max="5000" value="20" class="w-24 rounded-lg px-3 py-1.5 bg-white/5 border border-white/10" />
                  </div>
                  <button id="openModal" class="ml-2 bg-emerald-400 text-black font-semibold px-4 py-2 rounded-xl">
                    Donate
                  </button>
                </div>
              </div>
            </div>

          <div id="map" class="card overflow-hidden relative z-0"></div>
          <div id="mapStatus" class="mt-2 badge">Loading world‚Ä¶</div>
        </div>

        <aside class="lg:sticky lg:top-28">
          <div class="card p-5">
            <div class="flex items-center justify-between">
              <h2 class="text-xl font-semibold">üî• Today‚Äôs heat</h2>
              <a href="#leaders" class="text-sm text-slate-300 hover:text-white">Leaders ‚Üí</a>
            </div>
            <ul id="todayList" class="mt-4 space-y-4">
              <li class="text-slate-400 text-sm">Fetching stats‚Ä¶</li>
            </ul>
            <div class="mt-3 text-xs opacity-70"><a href="/.netlify/functions/leaders?by=countries&window=7d" target="_blank" class="underline">Open Leaders API</a></div>
            <div class="mt-5 text-sm text-slate-300">We display @handles only with consent. Anonymous is possible.</div>
          </div>

          <div class="card p-5 mt-6">
            <h3 class="text-lg font-semibold">Become a Captain</h3>
            <p class="text-slate-300 mt-2">Bring your community to the map. Apply with your email and public handle ‚Äî we‚Äôll reach out.</p>
            <form id="joinForm" class="mt-3 space-y-2">
              <input name="email" type="email" placeholder="you@example.com" required class="w-full rounded-lg px-3 py-2 bg-white/5 border border-white/10" />
              <input name="handle" placeholder="your-handle" required class="w-full rounded-lg px-3 py-2 bg-white/5 border border-white/10" />
              <input name="country_iso" placeholder="ISO-3 (optional)" class="w-full rounded-lg px-3 py-2 bg-white/5 border border-white/10" />
              <textarea name="message" placeholder="Why you? (optional)" class="w-full rounded-lg px-3 py-2 bg-white/5 border border-white/10"></textarea>
              <button class="bg-white text-black font-semibold px-4 py-2 rounded-xl">Apply</button>
              <div id="joinMsg" class="text-sm text-slate-300"></div>
            </form>
          </div>
        </aside>
      </div>
    </section>

    <section id="how" class="mx-auto max-w-7xl px-6 mt-12 mb-16">
      <div class="card p-6">
        <h2 class="text-2xl font-semibold mb-3">How it works</h2>
        <ol class="list-decimal ml-5 space-y-2 text-slate-200">
          <li>Tap the map to pick a country, or choose from the select.</li>
          <li>Pick an amount (5/20/50/100) or type your own, then hit Donate.</li>
          <li>Pay securely with Stripe (card or Link). We store minimal info.</li>
          <li>Within seconds, the map lights up and the sidebar updates.</li>
        </ol>
        <p class="mt-4 text-sm text-slate-400">Stripe Test: use card <code>4242 4242 4242 4242</code>.</p>
      </div>
    </section>
  </main>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black/60 z-40">
    <div class="card w-[560px] max-w-[94vw] p-5">
      <div class="flex items-center justify-between">
        <div class="text-lg font-semibold">Donate to <span id="modalCountry">Croatia</span></div>
        <button id="closeModal" class="px-3 py-1.5 rounded-lg border border-white/10 hover:bg-white/10">Close</button>
      </div>
      <div class="mt-4 space-y-3">
        <div class="flex items-center gap-2">
          <span class="opacity-70">EUR</span>
          <input id="amtModal" type="number" min="1" max="5000" value="20" class="w-32 rounded-lg px-3 py-2 bg-white/5 border border-white/10" />
          <div class="ml-auto flex gap-2">
            <button data-amt="5" class="amt2 px-3 py-1.5 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10">‚Ç¨5</button>
            <button data-amt="20" class="amt2 px-3 py-1.5 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10">‚Ç¨20</button>
            <button data-amt="50" class="amt2 px-3 py-1.5 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10">‚Ç¨50</button>
            <button data-amt="100" class="amt2 px-3 py-1.5 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10">‚Ç¨100</button>
          </div>
        </div>
        <button id="payNow" class="bg-emerald-400 text-black font-semibold px-4 py-2 rounded-xl">Pay with Stripe</button>
        <div class="text-sm text-slate-400">Goes to Stripe Checkout. You can cancel anytime.</div>
      </div>
    </div>
  </div>

  <footer class="mx-auto max-w-7xl px-6 pb-12">
    <div class="mt-10 text-sm text-slate-400">¬© TapTheMap</div>
  </footer>

  <script>
    // ---------- Helpers ----------
    const euro = (x)=> new Intl.NumberFormat('en', { style:'currency', currency:'EUR', maximumFractionDigits:0 }).format(x);
    const isoFrom = (p)=> (p.iso_a3 || p.ISO_A3 || p.ADM0_A3 || p.ISO3 || '').toUpperCase();
    const nameFrom= (p)=> (p.NAME_EN || p.ADMIN || p.NAME || p.name || 'Unknown');

    // ---------- Elements ----------
    const mapEl = document.getElementById('map');
    const modal = document.getElementById('modal');
    const modalCountry = document.getElementById('modalCountry');
    const closeModalBtn = document.getElementById('closeModal');
    const openModalBtn = document.getElementById('openModal');
    const payNow = document.getElementById('payNow');
    const amtInput = document.getElementById('amtInput');
    const amtModal = document.getElementById('amtModal');
    const mapStatus = document.getElementById('mapStatus');
    const todayList = document.getElementById('todayList');
    const countrySelect = document.getElementById('countrySelect');

    // ---------- State ----------
    let totalsByIso = {}; let maxTotal = 0;
    let chosen = { country_iso:'HRV', country_name:'Croatia', amount:20, ref:'' };

    // Capture referral from URL (?r=handle)
    const __qs = new URLSearchParams(location.search);
    const __ref = (__qs.get('r') || '').replace(/[^a-z0-9_\-\.]/gi, '').slice(0, 64);
    if (__ref) { chosen.ref = __ref; }

    function openModal(){ modal.classList.remove('hidden'); modalCountry.textContent = chosen.country_name; }
    function closeModal(){ modal.classList.add('hidden'); }

    closeModalBtn.addEventListener('click', closeModal);
    openModalBtn.addEventListener('click', ()=>{ chosen.amount = clampAmt(+amtInput.value || 20); amtModal.value = chosen.amount; openModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

    // quick amounts ‚Üí input
    document.querySelectorAll('.amt').forEach(b=> b.addEventListener('click', ()=>{ amtInput.value = b.dataset.amt; }));
    document.querySelectorAll('.amt2').forEach(b=> b.addEventListener('click', ()=>{ amtModal.value = b.dataset.amt; }));

    function clampAmt(v){ return Math.max(1, Math.min(5000, Math.floor(v || 20))); }

    // ---------- Map & choropleth ----------
    const map = L.map(mapEl, { worldCopyJump:true, minZoom:2, maxZoom:6, zoomControl:true }).setView([20, 0], 2);
    L.tileLayer('https://cartodb-basemaps-b.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png', { attribution:'¬© OpenStreetMap, ¬© Carto' }).addTo(map);

    const layersByIso = new Map();
    const hoverStyle = { weight:1.5, color:'#cbd5e1', fillOpacity:0.85 };
    const colorScale = (total)=>{
      // log scale ‚Üí 0..10000+ EUR
      const steps = ['#0b172a','#0f2141','#12305f','#15407c','#18509a','#1a60b8','#1d70d6','#2488ff','#4fa0ff','#8fd0ff'];
      const v = Math.log10((total||0)+1); const idx = Math.min(steps.length-1, Math.floor(v*(steps.length-1)));
      return { color:'#0f172a', weight:0.6, fillColor:steps[idx], fillOpacity:0.75 };
    };

    fetch('https://unpkg.com/geojson-world@3.0.0/countries.geo.json')
      .then(r=>r.json())
      .then(gj=>{
        const g = L.geoJSON(gj, {
          style: f=> colorScale(0),
          onEachFeature: (f, lyr) => {
            const iso = isoFrom(f.properties);
            const name = nameFrom(f.properties);
            layersByIso.set(iso, lyr);

            const tip = ()=> {
              const total = totalsByIso[iso] ? Number(totalsByIso[iso]) : 0;
              return total > 0 ? `${name} ¬∑ ${euro(total)}` : name;
            };
            lyr.bindTooltip(tip(), { sticky:true, opacity:0.95 });

            lyr.on({
              mouseover: (e)=>{
                e.target.setStyle(hoverStyle); e.target.bringToFront(); map.getContainer().style.cursor='pointer';
              },
              mouseout:  (e)=>{
                // vrati stil prema trenutnim totalima
                const t = totalsByIso[iso] ? Number(totalsByIso[iso]) : 0;
                e.target.setStyle(colorScale(t)); map.getContainer().style.cursor='';
              },
              click:     (e)=>{
                chosen.country_iso = iso || chosen.country_iso;
                chosen.country_name = name || chosen.country_name;
                modalCountry.textContent = chosen.country_name;

                const val = `${chosen.country_iso}|${chosen.country_name}`;
                let opt = Array.from(countrySelect.options).find(o=>o.value.startsWith(chosen.country_iso + '|'));
                if (!opt) { opt = new Option(`${chosen.country_name} (${chosen.country_iso})`, val); countrySelect.add(opt); }
                countrySelect.value = val;

                const b = e.target.getBounds(); if (b && b.isValid()) map.fitBounds(b, { maxZoom:4, padding:[20,20] });
                openModal();
              }
            });
          }
        }).addTo(map);
        // nakon ≈°to je karta spremna, povuci prve statistike
        refreshStats(true);
      });

    // promjena dr≈æave iz selecta
    countrySelect.addEventListener('change', (e)=>{
      const [iso, name] = (e.target.value || '').split('|');
      chosen.country_iso = iso; chosen.country_name = name; modalCountry.textContent = name;
    });
    countrySelect.value = `${chosen.country_iso}|${chosen.country_name}`;

    // ---------- Checkout ----------
    payNow.addEventListener('click', async ()=>{
      try {
        const res = await fetch('/.netlify/functions/checkout', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(chosen)
        });
        if (res.status === 503) { alert('Payments are not configured yet. Add STRIPE keys in Netlify ENV.'); return; }
        if (!res.ok) { const t = await res.text(); alert('Checkout error: ' + t); return; }
        const { url } = await res.json(); if (url) location.href = url; else alert('No checkout URL returned.');
      } catch { alert('Network error.'); }
    });

    // ---------- Stats (polling + render) ----------
    async function refreshStats(first = false){
      try{
        const r = await fetch('/.netlify/functions/stats', { cache: 'no-store' });
        if(!r.ok){ throw new Error(await r.text()); }
        const items = await r.json(); // [{ iso, name, total_eur, donors_24h, donors_7d }]
        // mapiraj totals
        totalsByIso = {};
        let localMax = 0;
        for(const it of items){
          const iso = (it.iso || it.country_iso || '').toUpperCase();
          const total = Number(it.total_eur || 0);
          totalsByIso[iso] = total;
          if (total > localMax) localMax = total;
        }
        maxTotal = localMax;

        // oboji poligone po totalu
        layersByIso.forEach((lyr, iso)=>{
          const total = totalsByIso[iso] ? Number(totalsByIso[iso]) : 0;
          lyr.setStyle(colorScale(total));
          const nm = (lyr.feature && lyr.feature.properties) ? (lyr.feature.properties.NAME_EN || lyr.feature.properties.ADMIN || 'Unknown') : iso;
          const tip = total > 0 ? `${nm} ¬∑ ${euro(total)}` : nm;
          lyr.bindTooltip(tip, { sticky:true, opacity:0.95 });
        });

        // render ‚ÄúToday‚Äôs heat‚Äù (top 10 po donors_24h pa total)
        renderToday(items);

        if(first){
          mapStatus.textContent = 'World & stats live ‚úì';
        }
      }catch(e){
        console.error('Stats error', e);
        todayList.innerHTML = `<li class="text-slate-400 text-sm">Stats unavailable.</li>`;
        if(first){ mapStatus.textContent = 'World ready (stats unavailable)'; }
      } finally {
        setTimeout(()=>refreshStats(false), 20000); // 20 s
      }
    }

    function renderToday(items){
      if(!Array.isArray(items) || items.length===0){
        todayList.innerHTML = `<li class="text-slate-400 text-sm">No activity yet. Be the first ‚ú®</li>`;
        return;
      }
      const top = [...items]
        .sort((a,b)=>{
          const d = (b.donors_24h||0) - (a.donors_24h||0);
          if (d!==0) return d;
          return (Number(b.total_eur||0) - Number(a.total_eur||0));
        })
        .slice(0,10);

      todayList.innerHTML = top.map(it=>{
        const iso = (it.iso || it.country_iso || '').toUpperCase();
        const name = it.name || it.country_name || iso;
        const donors = it.donors_24h || 0;
        const total  = Number(it.total_eur || 0);
        return `
          <li class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="inline-flex w-8 h-8 rounded-full bg-emerald-500/10 text-emerald-300 items-center justify-center border border-emerald-400/40 text-sm">${iso}</span>
              <div>
                <div class="font-semibold">${name}</div>
                <div class="text-xs text-slate-400 mini">${donors} donors ¬∑ ${euro(total)} total</div>
              </div>
            </div>
            <div class="text-sm text-slate-300 mini">${euro(total)}</div>
          </li>`;
      }).join('');
    }

    // Thank-you toast after successful Stripe return
    if (__qs.get('ok') === '1') {
      const el = document.createElement('div');
      el.textContent = 'Hvala! Uplata je pro≈°la.';
      Object.assign(el.style, {
        position:'fixed', right:'16px', bottom:'16px',
        background:'#101725', color:'#cfe2ff',
        border:'1px solid #24314f', padding:'10px 12px',
        borderRadius:'10px', zIndex:9999
      });
      document.body.appendChild(el);
      setTimeout(()=> el.remove(), 3000);
    }
  </script>
</body>
</html>
