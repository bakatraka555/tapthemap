<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TapTheMap — Donate to a country</title>
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <style>
    :root { --bg:#0b0d12; --fg:#e6e8ee; --muted:#98a2b3; --card:#11151f; --accent:#5b9cff; --accent2:#27c3a1; --danger:#ff6b6b; }
    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--fg); font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
    a { color: var(--accent); text-decoration: none; }
    .layout { display:grid; grid-template-columns: 1fr 340px; grid-template-rows: 100%; height:100%; }
    #map { width:100%; height:100%; border-right:1px solid #1a2030; }
    aside { background: var(--card); height:100%; display:flex; flex-direction:column; }
    header { padding:14px 16px; border-bottom:1px solid #1a2030; display:flex; align-items:center; justify-content:space-between; }
    header h1 { font-size:16px; margin:0; letter-spacing:.3px; }
    .pill { background:#1a2030; border:1px solid #242b3d; padding:6px 10px; border-radius:999px; color:var(--muted); font-size:12px; }
    .panel { padding:14px 16px; border-bottom:1px solid #1a2030; }
    .panel h3 { margin:0 0 8px; font-size:13px; color:#c8ceda; text-transform:uppercase; letter-spacing:.12em; }
    .list { margin:0; padding:0; list-style:none; }
    .list li { display:flex; align-items:center; justify-content:space-between; padding:8px 0; border-bottom:1px dashed #1c2332; }
    .list li:last-child { border-bottom:none; }
    .country { color:#dbe2f2; }
    .amt { color:#8fd0ff; font-variant-numeric: tabular-nums; }

    /* Modal */
    .modal-backdrop { position:fixed; inset:0; background:rgba(6,8,12,.65); display:none; align-items:center; justify-content:center; z-index:1000; }
    .modal { width:min(560px, 92vw); background: #0f1420; border:1px solid #1f2840; border-radius:14px; box-shadow: 0 10px 40px rgba(0,0,0,.5); overflow:hidden; }
    .modal header { border-bottom:1px solid #1f2840; }
    .modal .body { padding:16px; display:grid; gap:14px; }
    .row { display:flex; gap:10px; align-items:center; }
    .row .grow { flex:1; }
    .kbd { background:#0b0f19; border:1px solid #1f2840; border-radius:8px; padding:10px 12px; font-size:14px; color:#cfd7ea; }
    .btn { background:var(--accent); color:#001029; border:none; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer; }
    .btn[disabled] { opacity:.6; cursor:not-allowed; }
    .btn.sec { background:#1a2030; color:#cfd7ea; border:1px solid #27324a; }
    .btn.ghost { background:transparent; color:#9fb7ff; border:1px solid #2a3a66; }
    .chip { background:#142035; color:#cfe2ff; border:1px solid #203054; padding:8px 10px; border-radius:8px; cursor:pointer; }
    .chip.active { outline:2px solid var(--accent); }

    .toast { position: fixed; right: 16px; bottom: 16px; background:#101725; border:1px solid #24314f; padding:10px 12px; border-radius:10px; display:none; }

    /* Leaflet overrides */
    .leaflet-control-attribution, .leaflet-control-zoom { filter: invert(.9) hue-rotate(180deg); }
  </style>
</head>
<body>
  <div class="layout">
    <div id="map"></div>
    <aside>
      <header>
        <h1>TapTheMap</h1>
        <span class="pill" id="status-pill">idle</span>
      </header>
      <div class="panel">
        <h3>How it works</h3>
        <p style="margin:0;color:var(--muted)">Tap a country → choose an amount → pay via Stripe. Your tap fuels the heatmap.</p>
      </div>
      <div class="panel">
        <h3>Today’s heat</h3>
        <ol class="list" id="heat-list"></ol>
      </div>
      <div class="panel">
        <h3>Quick links</h3>
        <div class="row">
          <a class="btn ghost" href="/.netlify/functions/stats" target="_blank">/stats</a>
          <a class="btn ghost" href="/.netlify/functions/leaders?by=countries&window=7d" target="_blank">/leaders</a>
        </div>
      </div>
      <div style="margin-top:auto" class="panel">
        <small style="color:var(--muted)">Stripe Test mode — use card <code>4242 4242 4242 4242</code></small>
      </div>
    </aside>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="donate-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <header style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;">
        <strong id="donate-title">Donate</strong>
        <button class="btn sec" id="donate-close">Close</button>
      </header>
      <div class="body">
        <div class="row"><div class="grow" id="donate-country" style="color:#cfe2ff"></div></div>
        <div class="row" aria-label="quick amounts">
          <button class="chip" data-amt="5">€5</button>
          <button class="chip" data-amt="10">€10</button>
          <button class="chip active" data-amt="20">€20</button>
          <button class="chip" data-amt="50">€50</button>
          <button class="chip" data-amt="100">€100</button>
        </div>
        <div class="row">
          <label class="kbd">EUR</label>
          <input id="amt" class="kbd grow" type="number" min="1" max="5000" step="1" value="20" />
          <button class="btn sec" id="amt-minus">−</button>
          <button class="btn sec" id="amt-plus">＋</button>
        </div>
        <div class="row">
          <button class="btn" id="pay-btn">Pay with Stripe</button>
          <span id="pay-msg" style="color:var(--muted)"></span>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    // ---------- Utilities ----------
    const qs = new URLSearchParams(location.search);
    const referral = (qs.get('r')||'').replace(/[^a-z0-9_\-\.]/gi,'').slice(0,64);

    function euro(x){ return new Intl.NumberFormat('en', { style:'currency', currency:'EUR', maximumFractionDigits:0 }).format(x); }
    function toast(t){ const el=document.getElementById('toast'); el.textContent=t; el.style.display='block'; setTimeout(()=>el.style.display='none', 3000); }
    function setStatus(s){ document.getElementById('status-pill').textContent = s; }

    // ---------- Map ----------
    const map = L.map('map', { worldCopyJump:true, minZoom:2 }).setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);

    let countriesLayer; const countryIndex = new Map();
    const palette = ['#0b172a','#0f2141','#12305f','#15407c','#18509a','#1a60b8','#1d70d6','#2488ff','#4fa0ff','#8fd0ff'];

    function colorFor(value){
      // value in EUR, simple log scale
      if (!value || value<=0) return '#0b172a';
      const v = Math.log10(value+1); // 0..~
      const idx = Math.min(palette.length-1, Math.floor(v*(palette.length-1)));
      return palette[idx];
    }

    async function loadCountries(){
      // Lightweight GeoJSON of world countries
      const res = await fetch('https://unpkg.com/geojson-world@3.0.0/countries.geo.json');
      const gj = await res.json();
      countriesLayer = L.geoJSON(gj, {
        style: f => ({ color:'#1a2030', weight:1, fillColor:'#0b172a', fillOpacity:.9 }),
        onEachFeature: (feature, layer) => {
          const props = feature.properties||{};
          const name = props.name || props.ADMIN || 'Unknown';
          const iso3 = (props.iso_a3 || props.ISO_A3 || props.iso3 || '').toUpperCase();
          if (iso3) countryIndex.set(iso3, layer);
          layer.bindTooltip(name, { sticky:true, direction:'top' });
          layer.on('click', ()=> openDonateModal({ iso: iso3 || 'UNK', name }));
          layer.on('mouseover', ()=> layer.setStyle({ weight:2 }));
          layer.on('mouseout', ()=> layer.setStyle({ weight:1 }));
        }
      }).addTo(map);
    }

    function repaintChoropleth(totalsByIso){
      if (!countriesLayer) return;
      countriesLayer.eachLayer(layer => {
        const feature = layer.feature||{}; const p = feature.properties||{};
        const iso3 = (p.iso_a3 || p.ISO_A3 || p.iso3 || '').toUpperCase();
        const total = totalsByIso.get(iso3) || 0;
        layer.setStyle({ fillColor: colorFor(total) });
      });
    }

    // ---------- Modal / Checkout ----------
    const backdrop = document.getElementById('donate-backdrop');
    const titleEl = document.getElementById('donate-title');
    const countryEl = document.getElementById('donate-country');
    const amtEl = document.getElementById('amt');
    const payBtn = document.getElementById('pay-btn');
    const payMsg = document.getElementById('pay-msg');

    let currentCountry = { iso:'HRV', name:'Croatia' };

    function openDonateModal({iso, name}){
      currentCountry = { iso, name };
      titleEl.textContent = `Donate to ${name}`;
      countryEl.textContent = `${name} (${iso})`;
      backdrop.style.display = 'flex';
      payMsg.textContent = '';
      payBtn.disabled = false;
      amtEl.focus();
    }

    document.getElementById('donate-close').addEventListener('click', ()=> backdrop.style.display='none');
    backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) backdrop.style.display='none'; });

    document.querySelectorAll('.chip').forEach(ch => ch.addEventListener('click', () => {
      document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
      ch.classList.add('active');
      amtEl.value = ch.dataset.amt;
    }));
    document.getElementById('amt-minus').addEventListener('click', ()=> amtEl.value = Math.max(1, (+amtEl.value||1)-1));
    document.getElementById('amt-plus').addEventListener('click', ()=> amtEl.value = Math.min(5000, (+amtEl.value||1)+1));

    async function startCheckout(){
      try{
        payBtn.disabled = true; payMsg.textContent = 'Starting checkout...';
        const payload = {
          country_iso: currentCountry.iso,
          country_name: currentCountry.name,
          amount: Math.max(1, Math.min(5000, Math.floor(+amtEl.value||20))),
          ref: referral || undefined
        };
        const res = await fetch('/.netlify/functions/checkout', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const json = await res.json().catch(()=>({}));
        if(res.ok && json.url){ location.href = json.url; return; }
        throw new Error(typeof json === 'string' ? json : (json.error || 'Checkout failed'));
      }catch(e){
        payMsg.textContent = String(e.message||e);
        payBtn.disabled = false;
      }
    }
    payBtn.addEventListener('click', startCheckout);

    // ---------- Stats polling ----------
    async function refreshStats(){
      try{
        setStatus('loading');
        const res = await fetch('/.netlify/functions/stats');
        const arr = await res.json();
        const list = document.getElementById('heat-list');
        list.innerHTML = '';
        // Build totals map for choropleth
        const totals = new Map();
        (arr||[]).forEach(r => { totals.set((r.iso||r.country_iso||'').toUpperCase(), Number(r.total_eur||0)); });
        repaintChoropleth(totals);
        // Render top 10 today by donors_24h then total
        const top = (arr||[]).sort((a,b)=> (b.donors_24h||0)-(a.donors_24h||0) || (b.total_eur||0)-(a.total_eur||0)).slice(0,10);
        for(const r of top){
          const li = document.createElement('li');
          const name = r.name || r.country_name || r.iso;
          li.innerHTML = `<span class="country">${name}</span><span class="amt">€${Number(r.total_eur||0)}</span>`;
          list.appendChild(li);
        }
        setStatus('ok');
      }catch(e){ setStatus('error'); }
    }

    // ---------- Boot ----------
    (async function(){
      await loadCountries();
      refreshStats();
      setInterval(refreshStats, 20000);
      if(qs.get('ok')==='1'){ toast('Thank you! Payment succeeded.'); }
    })();
  </script>
</body>
</html>
