<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TapTheMap ‚Äî Fill the map</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script> tailwind.config={ theme:{extend:{fontFamily:{sans:['Inter','ui-sans-serif','system-ui']},colors:{ink:{900:'#0b1020'}}}}};</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  html,body{height:100%} body{background:#0b1020;color:#fff;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .card{backdrop-filter:blur(8px);background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:18px}
  #map{height:62vh;min-height:420px} .leaflet-container{background:#0b1020}
  .leaflet-interactive{transition:fill .25s,fill-opacity .25s,stroke-width .15s}
  .legend{font-size:.85rem;color:#e2e8f0}.legend .bar{height:10px;border-radius:6px;border:1px solid rgba(255,255,255,.25);margin:8px 0;background:linear-gradient(90deg,#38bdf8 0%,#22c55e 33%,#f59e0b 66%,#ef4444 100%)}
  .amt-btn.active{outline:2px solid #fff;outline-offset:2px}
  select{color:#fff!important;background-color:rgba(255,255,255,.1)!important;border:1px solid rgba(255,255,255,.15)!important}
  select:focus{outline:none;border-color:rgba(255,255,255,.35)!important} select option{color:#fff;background:#0b1020}
</style>
</head>
<body class="bg-ink-900 text-white antialiased">

<header class="sticky top-0 z-30">
  <div class="mx-auto max-w-7xl px-6 pt-5">
    <div class="card px-5 py-4 flex items-center justify-between">
      <a class="text-xl md:text-2xl font-bold">tapthemap.world</a>
      <nav class="hidden md:flex items-center gap-8 text-slate-200/90">
        <a href="#leaders" class="hover:text-white">Leaders</a>
        <a href="#about" class="hover:text-white">About</a>
        <a href="#faq" class="hover:text-white">FAQ</a>
      </nav>
      <div id="refBadge" class="hidden md:flex items-center gap-2 text-sm">
        <span class="px-2.5 py-1 rounded-full bg-emerald-700/40 border border-emerald-400/40">Supporting <b id="refName">@ref</b></span>
        <button id="refClear" class="text-slate-300 hover:text-white underline">Clear</button>
      </div>
    </div>
  </div>
</header>

<main>
  <section class="mx-auto max-w-7xl px-6">
    <div class="grid lg:grid-cols-[1fr_380px] gap-6 mt-10">
      <div>
        <div class="mb-6">
          <h1 class="text-3xl md:text-5xl font-bold leading-tight">Fill the map. Your country, your pride.</h1>
          <p class="mt-4 text-slate-300 max-w-2xl">
            Tap your country and choose 5 / 20 / 50 / 100 ‚Ç¨ or ‚ÄúOther‚Äù.
            Every contribution lights up your land. <span class="text-slate-200">Secure by Stripe ¬∑ SSL ¬∑ Anonymous option.</span>
          </p>
          <div class="mt-5 flex items-center gap-3 text-slate-300 text-sm">
            <span class="inline-flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span> Live</span>
            <span>¬∑</span><span>Apple/Google Pay supported</span>
          </div>
        </div>

        <div class="flex items-center gap-3 mb-3">
          <label for="countrySelect" class="text-sm text-slate-300">Country:</label>
          <select id="countrySelect" class="rounded-xl px-3 py-2 text-sm">
            <option value="HRV|Croatia">Croatia (HRV)</option>
            <option value="USA|United States">United States (USA)</option>
            <option value="SAU|Saudi Arabia">Saudi Arabia (SAU)</option>
            <option value="LBY|Libya">Libya (LBY)</option>
            <option value="DZA|Algeria">Algeria (DZA)</option>
            <option value="RUS|Russia">Russia (RUS)</option>
          </select>
          <button id="openDonate" class="inline-flex items-center gap-2 bg-emerald-600 hover:bg-emerald-500 text-white font-semibold px-4 py-2 rounded-xl">Donate</button>
        </div>

        <div id="map" class="card overflow-hidden relative z-0"></div>
        <div id="mapStatus" class="mt-2 text-lime-300 text-sm">Loading world‚Ä¶</div>
      </div>

      <aside class="lg:sticky lg:top-28">
        <div class="card p-5">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-semibold">üî• Today‚Äôs heat</h2>
            <a href="#leaders" class="text-sm text-slate-300 hover:text-white">Leaders ‚Üí</a>
          </div>
          <ul id="todayList" class="mt-4 space-y-4"><li class="text-slate-400 text-sm">Fetching stats‚Ä¶</li></ul>
          <div class="mt-5 text-sm text-slate-300">We display @handles only with consent. Anonymous is possible.</div>
        </div>

        <div class="card p-5 mt-6" id="captainsCard">
          <h3 class="text-lg font-semibold">Top Captains (7d)</h3>
          <ul id="captainsList" class="mt-4 space-y-3"><li class="text-slate-400 text-sm">Loading‚Ä¶</li></ul>
        </div>
      </aside>
    </div>
  </section>
</main>

<!-- Donate modal -->
<div id="donateModal" class="fixed inset-0 z-40 hidden">
  <div class="absolute inset-0 bg-black/60"></div>
  <div class="relative z-10 max-w-2xl mx-auto mt-24 pointer-events-none">
    <div class="bg-white text-slate-900 rounded-2xl shadow-2xl border border-slate-200 pointer-events-auto">
      <div class="p-6 border-b border-slate-200 flex items-center justify-between">
        <div><div id="modalCountry" class="text-xl font-bold">Croatia</div><div class="text-sm text-slate-600">Choose amount</div></div>
        <button type="button" id="closeModal" class="p-2 text-slate-500 hover:text-slate-800">‚úï</button>
      </div>
      <div class="p-6 grid md:grid-cols-[1fr_160px] gap-6">
        <div>
          <div class="flex flex-wrap gap-3" id="amtWrap">
            <button type="button" data-amt="5"   class="amt-btn bg-blue-600 hover:bg-blue-500 text-white font-semibold px-5 py-2.5 rounded-xl">5 ‚Ç¨</button>
            <button type="button" data-amt="20"  class="amt-btn bg-blue-600 hover:bg-blue-500 text-white font-semibold px-5 py-2.5 rounded-xl">20 ‚Ç¨</button>
            <button type="button" data-amt="50"  class="amt-btn bg-blue-600 hover:bg-blue-500 text-white font-semibold px-5 py-2.5 rounded-xl">50 ‚Ç¨</button>
            <button type="button" data-amt="100" class="amt-btn bg-blue-600 hover:bg-blue-500 text-white font-semibold px-5 py-2.5 rounded-xl">100 ‚Ç¨</button>
            <div class="flex items-center gap-2 bg-slate-100 rounded-xl px-3 py-2">
              <input id="otherAmt" type="number" min="1" step="1" placeholder="Other" class="w-24 bg-transparent outline-none text-slate-800"/>
              <button type="button" id="otherBtn" class="text-blue-700 font-semibold">OK</button>
            </div>
          </div>
          <div class="mt-4 text-sm text-slate-600">Private gift, no quid pro quo. We show @handles only with consent.</div>
        </div>
        <div>
          <div class="rounded-xl border border-slate-200 p-3 grid place-items-center h-[150px] text-slate-500">
            <div id="qrBox">QR will appear after creating the Checkout link</div>
          </div>
          <button type="button" id="payNow" class="mt-3 w-full bg-emerald-600 hover:bg-emerald-500 text-white font-semibold px-4 py-2.5 rounded-xl">Pay now</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== Helpers ===== */
const euro = n=>'‚Ç¨'+Number(n).toLocaleString('en-US',{maximumFractionDigits:0});
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const getParam=k=>new URLSearchParams(location.search).get(k);
const sanitizeRef=s=>(s||'').toString().replace(/[^a-zA-Z0-9_.-]/g,'').slice(0,32);

function hslToHex(h,s,l){s/=100;l/=100;const k=n=>(n+h/30)%12,a=s*Math.min(l,1-l),
f=n=>l-a*Math.max(-1,Math.min(k(n)-3,Math.min(9-k(n),1))),
toHex=x=>Math.round(255*x).toString(16).padStart(2,'0');
return`#${toHex(f(0))}${toHex(f(8))}${toHex(f(4))}`;}
function rampColor(t){const hue=195-195*t;return hslToHex(hue,85,53);}

/* ===== Referral ===== */
const refBadge=document.getElementById('refBadge');
const refName=document.getElementById('refName');
const refClear=document.getElementById('refClear');
const chosen={country_iso:'HRV',country_name:'Croatia',amount:20,ref:''};

(function initRef(){
  const fromUrl=sanitizeRef(getParam('r')||getParam('ref'));
  const fromStore=localStorage.getItem('ttm_ref')||'';
  const ref=fromUrl||fromStore;
  if(ref){chosen.ref=ref;localStorage.setItem('ttm_ref',ref);
    refName.textContent='@'+ref;refBadge.classList.remove('hidden');}
  refClear?.addEventListener('click',()=>{localStorage.removeItem('ttm_ref');chosen.ref='';refBadge.classList.add('hidden');});
})();

/* ===== Map ===== */
const map=L.map('map',{zoomControl:false,worldCopyJump:true,tap:false}).setView([20,0],2);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
  attribution:'&copy; OpenStreetMap & CARTO',detectRetina:true,maxZoom:6,minZoom:2
}).addTo(map);
map.createPane('countries');map.getPane('countries').style.zIndex=650;

const mapStatus=document.getElementById('mapStatus');
const countrySelect=document.getElementById('countrySelect');
const modalCountry=document.getElementById('modalCountry');

const Legend=L.Control.extend({
  onAdd:function(){const d=L.DomUtil.create('div','legend card p-3');
    d.innerHTML=`<div class="font-semibold">Intensity</div><div class="bar"></div><div class="flex justify-between text-xs"><span id="lgLow">Low</span><span id="lgHigh">High</span></div>`;
    return d;},onRemove:function(){}});
new Legend({position:'bottomleft'}).addTo(map);
const lgLow=()=>document.getElementById('lgLow');const lgHigh=()=>document.getElementById('lgHigh');

/* GeoJSON izvori s ISO_A3 */
const SOURCES=[
 'https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson',
 'https://cdn.jsdelivr.net/gh/datasets/geo-countries@master/data/countries.geojson',
 'https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json' // fallback (ima id=ISO3 u veƒáini sluƒçajeva)
];

function isoFromProps(p){
  const id=(p.id||'').toString().toUpperCase();
  const a3=(p.ISO_A3||p.ADM0_A3||p.iso_a3||'').toString().toUpperCase();
  const v=a3 || (id.length===3? id : '');
  return v || null;
}
function nameFromProps(p){return (p.ADMIN||p.NAME_EN||p.name||p.NAME_LONG||'Unknown');}

const baseStroke={color:'#94a3b8',weight:0.7};
const layersByIso=new Map();
let totalsByIso={};let minPos=0,maxPos=0;let geoReady=false,pendingRecolor=false;

function styleByValue(v){ if(!maxPos||!v) return {...baseStroke,fillColor:'#0ea5e9',fillOpacity:.18};
  const t=(Number(v)-minPos)/Math.max(1,(maxPos-minPos));return {...baseStroke,fillColor:rampColor(clamp(t,0,1)),fillOpacity:.62};}

function applyTotalsToLayers(){
  if(!geoReady||!layersByIso.size){pendingRecolor=true;return;}
  layersByIso.forEach((lyr,iso)=>{
    const tot=Number(totalsByIso[iso]||0);
    lyr.setStyle(styleByValue(tot));
    const nm=nameFromProps(lyr.feature.properties);
    lyr.bindTooltip(tot>0?`${nm} ¬∑ ‚Ç¨${tot.toFixed(0)}`:nm,{sticky:true,opacity:.95});
  });
  // debug: koje ISO iz stats ne postoje u geojsonu
  const missing=[];Object.keys(totalsByIso).forEach(i=>{if(!layersByIso.has(i)) missing.push(i);});
  if(missing.length) console.warn('Stats ISO w/out polygon:', missing.join(', '));
  pendingRecolor=false;
}

async function fetchAny(urls){
  let err;for(const u of urls){try{const r=await fetch(u,{cache:'no-store'});if(!r.ok)throw new Error(r.status);return await r.json();}catch(e){err=e}}
  throw err||new Error('All sources failed');
}

fetchAny(SOURCES).then(geo=>{
  mapStatus.textContent='World ready ‚úì';
  window.worldLayer=L.geoJSON(geo,{
    pane:'countries',
    style:f=>{const iso=isoFromProps(f.properties);const tot=Number(totalsByIso[iso]||0);return styleByValue(tot);},
    onEachFeature:(f,lyr)=>{
      const iso=isoFromProps(f.properties);const name=nameFromProps(f.properties);
      if(iso) layersByIso.set(iso,lyr);
      const tip=()=>{const tot=Number(totalsByIso[iso]||0);return tot>0?`${name} ¬∑ ‚Ç¨${tot.toFixed(0)}`:name;}
      lyr.bindTooltip(tip(),{sticky:true,opacity:.95});
      lyr.on({
        mouseover:e=>{e.target.setStyle({...e.target.options,weight:1.3});e.target.bringToFront();map.getContainer().style.cursor='pointer';},
        mouseout: e=>{const tot=Number(totalsByIso[iso]||0);e.target.setStyle(styleByValue(tot));map.getContainer().style.cursor='';},
        click:    e=>{
          if(iso){chosen.country_iso=iso;chosen.country_name=name;modalCountry.textContent=name;
            const val=`${iso}|${name}`;let opt=Array.from(countrySelect.options).find(o=>o.value.startsWith(iso+'|'));
            if(!opt){opt=new Option(`${name} (${iso})`,val);countrySelect.add(opt);} countrySelect.value=val;
          }
          const b=e.target.getBounds();if(b&&b.isValid()) map.fitBounds(b,{maxZoom:4,padding:[20,20]}); openModal();
        }
      });
    }
  }).addTo(map);
  geoReady=true; if(pendingRecolor) applyTotalsToLayers();
  refreshStats(true); refreshCaptains();
}).catch(()=>{mapStatus.textContent='World failed to load';});

/* ===== Modal & iznosi (delegirano) ===== */
const modal=document.getElementById('donateModal');
const openDonateBtn=document.getElementById('openDonate');
const closeBtn=document.getElementById('closeModal');
const payNow=document.getElementById('payNow');

function openModal(){modal.classList.remove('hidden');modalCountry.textContent=chosen.country_name;}
function closeModal(){modal.classList.add('hidden');}

openDonateBtn?.addEventListener('click',openModal);
closeBtn?.addEventListener('click',closeModal);
countrySelect.addEventListener('change',()=>{const [iso,name]=countrySelect.value.split('|');chosen.country_iso=iso;chosen.country_name=name;modalCountry.textContent=name;});

// delegirani klik na gumbe s iznosima
document.addEventListener('click',(e)=>{
  const b=e.target.closest('.amt-btn');
  if(b){ e.preventDefault();
    document.querySelectorAll('.amt-btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active'); chosen.amount=Number(b.dataset.amt)||5;
  }
  if(e.target.id==='otherBtn'){
    const v=parseInt(document.getElementById('otherAmt').value,10);
    if(v>0){ chosen.amount=v; document.querySelectorAll('.amt-btn').forEach(x=>x.classList.remove('active')); }
  }
});

// inicijalno aktiviraj 20
(function(){ const def=document.querySelector('.amt-btn[data-amt="20"]'); if(def) def.classList.add('active'); })();

/* ===== Checkout ===== */
payNow.addEventListener('click',async ()=>{
  const active=document.querySelector('.amt-btn.active'); if(active) chosen.amount=Number(active.dataset.amt)||chosen.amount;
  const alt=parseInt(document.getElementById('otherAmt').value,10); if(!active && alt>0) chosen.amount=alt;
  if(!chosen.amount||chosen.amount<1){alert('Choose an amount.');return;}
  try{
    const res=await fetch('/.netlify/functions/checkout',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({country_iso:chosen.country_iso,country_name:chosen.country_name,amount:Number(chosen.amount),ref:chosen.ref||''})});
    if(res.status===503){alert('Payments are not configured yet. Add STRIPE keys in Netlify ENV.');return;}
    if(!res.ok){alert('Checkout error: '+await res.text());return;}
    const {url}=await res.json(); if(url) location.href=url; else alert('No checkout URL returned.');
  }catch(err){console.error(err);alert('Network error.');}
});

/* ===== Stats & heat ===== */
const todayList=document.getElementById('todayList'); let statsTimer=null;

async function refreshStats(first=false){
  try{
    const r=await fetch('/.netlify/functions/stats',{cache:'no-store'}); if(!r.ok)throw new Error(await r.text());
    const items=await r.json();
    totalsByIso={}; const vals=[];
    for(const it of (items||[])){ const iso=(it.iso||it.country_iso||'').toUpperCase(); const tot=Number(it.total_eur||0); if(!iso) continue; totalsByIso[iso]=tot; if(tot>0) vals.push(tot); }
    minPos=vals.length?Math.min(...vals):0; maxPos=vals.length?Math.max(...vals):0;
    if(vals.length){lgLow().textContent=euro(minPos);lgHigh().textContent=euro(maxPos);} else {lgLow().textContent='Low';lgHigh().textContent='High';}
    applyTotalsToLayers(); renderToday(items);
    if(first) mapStatus.textContent='World & stats live ‚úì';
  }catch(e){
    console.error('Stats error',e); todayList.innerHTML=`<li class="text-slate-400 text-sm">Stats unavailable.</li>`;
    if(first) mapStatus.textContent='World ready (stats unavailable)';
  }finally{ clearTimeout(statsTimer); statsTimer=setTimeout(()=>refreshStats(false),20000); }
}

function renderToday(items){
  const ul=todayList; if(!Array.isArray(items)||!items.length){ul.innerHTML=`<li class="text-slate-400 text-sm">No activity yet. Be the first ‚ú®</li>`;return;}
  const top=[...items].sort((a,b)=>Number(b.total_eur||0)-Number(a.total_eur||0)).slice(0,10);
  ul.innerHTML=top.map(it=>{
    const iso=(it.iso||it.country_iso||'').toUpperCase(); const name=it.name||it.country_name||iso; const total=Number(it.total_eur||0); const donors=Number(it.donors_24h||0);
    return `<li class="flex items-center justify-between"><div class="flex items-center gap-3">
      <span class="inline-flex w-8 h-8 rounded-full bg-emerald-600/25 items-center justify-center border border-emerald-400/40 text-sm">${iso}</span>
      <div><div class="font-semibold">${name}</div><div class="text-xs text-slate-400">${donors} donors (24h)</div></div></div><b>‚Ç¨${total.toFixed(0)}</b></li>`;
  }).join('');
}

/* ===== Captains (leaders) ===== */
const captainsList=document.getElementById('captainsList'); let capTimer=null;
async function refreshCaptains(){
  try{
    const r=await fetch('/.netlify/functions/leaders?window=7d&limit=10',{cache:'no-store'}); if(!r.ok) throw new Error(await r.text());
    const j=await r.json(); const list=j.by_ref||[];
    captainsList.innerHTML = list.length? list.map((it,i)=>`<li class="flex items-center justify-between">
      <div class="flex items-center gap-3"><span class="inline-flex w-8 h-8 rounded-full bg-emerald-600/25 items-center justify-center border border-emerald-400/40 text-sm">${i+1}</span>
      <div><div class="font-semibold">@${it.ref}</div><div class="text-xs text-slate-400">${it.donors_unique} unique ¬∑ ‚Ç¨${Number(it.total_eur||0).toFixed(0)}</div></div></div>
      <a class="text-sm px-3 py-1 rounded-lg bg-blue-600 hover:bg-blue-500" href="/?r=${encodeURIComponent(it.ref)}">Support</a></li>`).join('')
      : `<li class="text-slate-400 text-sm">No captains yet. Share your link (?r=yourhandle).</li>`;
  }catch(e){console.error(e);captainsList.innerHTML=`<li class="text-slate-400 text-sm">Leaders unavailable.</li>`;}
  finally{clearTimeout(capTimer);capTimer=setTimeout(refreshCaptains,30000);}
}
</script>
</body>
</html>
