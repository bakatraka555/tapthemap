<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>tapthemap.world</title>

  <!-- Tailwind (možeš kasnije skinuti CDN i buildati lokalno) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* lagani highlight za odabrani iznos */
    .amount-btn { @apply px-5 py-3 rounded-xl bg-slate-800/70 text-white hover:bg-slate-700 transition; }
    .amount-btn.active { @apply bg-blue-700 ring-2 ring-blue-300; }
    #otherWrap.active { @apply ring-2 ring-blue-300 rounded-xl; }
  </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">

  <main class="max-w-5xl mx-auto p-6">
    <h1 class="text-2xl font-semibold mb-6">Fill the map. Your country, your pride.</h1>

    <!-- ovdje može ići tvoja karta / sidebar / heat … -->

    <!-- Donacije modal/box (možeš ga smjestiti gdje želiš) -->
    <section class="mt-10 grid lg:grid-cols-2 gap-6">
      <div class="rounded-2xl bg-slate-900/60 p-6">
        <div class="flex items-center gap-2 mb-2 text-slate-300">
          <span class="uppercase text-xs tracking-wider">Country</span>
        </div>

        <!-- Ako klik s karte postavlja window.chosen, ovo je fallback select -->
        <select id="countrySelect" class="bg-slate-800/80 rounded-xl px-3 py-2">
          <option value="HRV|Croatia">Croatia (HRV)</option>
          <option value="USA|United States">United States (USA)</option>
          <option value="DZA|Algeria">Algeria (DZA)</option>
          <option value="LBY|Libya">Libya (LBY)</option>
          <option value="RUS|Russia">Russia (RUS)</option>
          <option value="SAU|Saudi Arabia">Saudi Arabia (SAU)</option>
        </select>

        <h2 class="mt-5 text-xl font-bold">
          <span id="countryTitle">Croatia</span>
        </h2>

        <p class="text-slate-400 text-sm mt-1">Choose amount</p>

        <div class="mt-4 flex flex-wrap gap-3">
          <button class="amount-btn js-amount" data-amount="5">5 €</button>
          <button class="amount-btn js-amount" data-amount="20">20 €</button>
          <button class="amount-btn js-amount" data-amount="50">50 €</button>
          <button class="amount-btn js-amount" data-amount="100">100 €</button>

          <div id="otherWrap" class="flex items-center gap-2 bg-slate-800/70 px-3 py-2 rounded-xl">
            <input id="otherAmt" type="number" min="1" step="1" placeholder="Other"
                   class="w-24 bg-transparent outline-none text-slate-100 placeholder:text-slate-400"/>
            <button id="otherBtn" class="px-3 py-1 rounded-lg bg-slate-700 hover:bg-slate-600">OK</button>
          </div>
        </div>

        <p class="text-slate-400 text-xs mt-4">
          Private gift, no quid pro quo. We show @handles only with consent. Secure by Stripe · SSL · Anonymous option.
        </p>

        <div class="mt-6 flex items-center justify-between">
          <div class="text-emerald-400 text-sm">Apple/Google Pay supported</div>
          <button id="payNow" class="px-5 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-500 font-semibold">
            Pay now
          </button>
        </div>
      </div>

      <aside class="rounded-2xl bg-slate-900/60 p-6">
        <h3 class="font-semibold mb-3">Today’s heat</h3>
        <div id="heatBox" class="text-sm text-slate-300">Loading…</div>
      </aside>
    </section>
  </main>

  <!-- ======= LOGIKA ZA IZNOS + CHECKOUT (ključni dio) ======= -->
  <script>
  (function () {
    // elementi
    const amountBtns = [...document.querySelectorAll('.js-amount, .amt-btn')];
    const otherInput  = document.getElementById('otherAmt');
    const otherOkBtn  = document.getElementById('otherBtn');
    const otherWrap   = document.getElementById('otherWrap');
    const payBtn      = document.getElementById('payNow');
    const countrySel  = document.getElementById('countrySelect');
    const countryLbl  = document.getElementById('countryTitle');

    // trenutno odabrani iznos
    let selectedAmount = 0;

    // ako koristiš window.chosen iz karte, ovo će preuzeti naziv/iso
    function currentCountry() {
      if (window.chosen?.country_iso && window.chosen?.country_name) {
        return { iso: window.chosen.country_iso, name: window.chosen.country_name, ref: window.chosen.ref || '' };
      }
      const [iso, name] = (countrySel?.value || 'HRV|Croatia').split('|');
      return { iso, name, ref: '' };
    }

    function refreshCountryLabel() {
      const { name } = currentCountry();
      if (countryLbl) countryLbl.textContent = name;
    }
    refreshCountryLabel();
    countrySel?.addEventListener('change', refreshCountryLabel, { passive: true });

    // UI za odabir iznosa
    function uiClear() {
      amountBtns.forEach(b => b.classList.remove('active'));
      otherWrap?.classList?.remove('active');
    }
    function uiMark(btn) {
      btn?.classList.add('active');
    }
    function updatePayCta() {
      if (!payBtn) return;
      payBtn.textContent = selectedAmount > 0 ? `Pay €${selectedAmount}` : 'Pay now';
    }
    function setAmount(val, btnToMark) {
      selectedAmount = Number(val) || 0;
      uiClear();
      uiMark(btnToMark);
      if (otherInput) otherInput.value = '';
      updatePayCta();
    }

    // klik na fiksne iznose
    amountBtns.forEach(btn => {
      const v = btn.dataset.amount || btn.dataset.amt || btn.getAttribute('data-amt') || btn.getAttribute('data-amount');
      btn.addEventListener('click', () => setAmount(v, btn), { passive: true });
    });

    // “Other → OK”
    otherOkBtn?.addEventListener('click', () => {
      const v = parseFloat(otherInput?.value ?? '');
      if (!isFinite(v) || v <= 0) return alert('Enter a valid amount.');
      uiClear();
      otherWrap?.classList?.add('active');
      selectedAmount = Math.round(v);
      updatePayCta();
    });

    // Pay now – ŠALJE STVARNO ODABRANI IZNOS
    payBtn?.addEventListener('click', async () => {
      if (selectedAmount <= 0) return alert('Choose amount first.');

      const { iso, name, ref } = currentCountry();

      try {
        const r = await fetch('/.netlify/functions/checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            country_iso: iso,
            country_name: name,
            amount: selectedAmount,      // ⬅⬅ KLJUČNO: točan iznos
            ref: ref || ''
          })
        });

        let out = {};
        try { out = await r.json(); } catch {}
        if (!r.ok) return alert('Checkout error: ' + (out.error || r.statusText));
        if (out.url) location.href = out.url; else alert('Checkout error.');
      } catch (e) {
        console.error(e);
        alert('Network error.');
      }
    });

    // inicijalno stanje tipke
    updatePayCta();

    // (opcionalno) učitaj “Today’s heat”
    (async function loadHeat() {
      try {
        const res = await fetch('/.netlify/functions/stats');
        const data = await res.json();
        const box = document.getElementById('heatBox');
        if (Array.isArray(data) && data.length) {
          box.innerHTML = data
            .slice(0, 10)
            .map(r => `<div class="flex justify-between"><span>${r.name}</span><span>€${r.total_eur}</span></div>`)
            .join('');
        } else {
          box.textContent = 'No data yet.';
        }
      } catch {
        const box = document.getElementById('heatBox');
        if (box) box.textContent = 'Stats temporarily unavailable.';
      }
    })();

  })();
  </script>
  <!-- ======= /kraj skripte ======= -->
</body>
</html>
