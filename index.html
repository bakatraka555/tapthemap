<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TapTheMap - Light Up Your Country</title>
    <meta name="description" content="Donate to light up your country on the global heat map. Support your nation and compete with others worldwide.">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui'],
                    },
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                        },
                        success: {
                            50: '#f0fdf4',
                            500: '#22c55e',
                            600: '#16a34a',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .map-container {
            height: 60vh;
            min-height: 400px;
        }
        
        .country-card {
            transition: all 0.3s ease;
        }
        
        .country-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .heat-gradient {
            background: linear-gradient(90deg, #3b82f6 0%, #22c55e 50%, #f59e0b 100%);
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 text-white min-h-screen">
    <!-- Header -->
    <header class="sticky top-0 z-50 glass-effect">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-green-400 bg-clip-text text-transparent">
                        TapTheMap
                    </h1>
                    <div class="flex items-center space-x-2 text-sm text-green-400">
                        <div class="w-2 h-2 bg-green-400 rounded-full pulse-animation"></div>
                        <span>Live</span>
                    </div>
                </div>
                
                <nav class="hidden md:flex items-center space-x-6">
                    <a href="#map" class="hover:text-blue-400 transition-colors">Map</a>
                    <a href="#leaders" class="hover:text-blue-400 transition-colors">Leaders</a>
                    <a href="#about" class="hover:text-blue-400 transition-colors">About</a>
                </nav>
                
                <div id="referral-badge" class="hidden items-center space-x-2 bg-green-500/20 px-3 py-1 rounded-full border border-green-400/30">
                    <span class="text-sm">Supporting</span>
                    <span id="referral-name" class="font-semibold text-green-400"></span>
                    <button id="clear-referral" class="text-xs text-gray-400 hover:text-white">×</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Hero Section -->
        <section class="text-center mb-12">
            <h2 class="text-4xl md:text-6xl font-bold mb-6 bg-gradient-to-r from-blue-400 via-green-400 to-yellow-400 bg-clip-text text-transparent">
                Light Up Your Country
            </h2>
            <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto">
                Donate to your country and watch it glow on the global heat map. 
                Compete with other nations and show your national pride!
            </p>
            
            <!-- Quick Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-2xl mx-auto mb-8">
                <div class="glass-effect rounded-lg p-4">
                    <div class="text-2xl font-bold text-blue-400" id="total-donations">€0</div>
                    <div class="text-sm text-gray-400">Total Donated</div>
                </div>
                <div class="glass-effect rounded-lg p-4">
                    <div class="text-2xl font-bold text-green-400" id="total-countries">0</div>
                    <div class="text-sm text-gray-400">Active Countries</div>
                </div>
                <div class="glass-effect rounded-lg p-4">
                    <div class="text-2xl font-bold text-yellow-400" id="total-donors">0</div>
                    <div class="text-sm text-gray-400">Total Donors</div>
                </div>
            </div>
    </section>

        <!-- Map and Sidebar -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Map Section -->
            <div class="lg:col-span-2">
                <div class="glass-effect rounded-xl p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold">Global Heat Map</h3>
                        <div class="text-sm text-gray-400" id="map-status">Loading...</div>
                    </div>
                    
                    <!-- Map Container -->
                    <div id="map" class="map-container rounded-lg overflow-hidden"></div>
                    
                    <!-- Legend -->
                    <div class="mt-4 flex items-center justify-between text-sm">
                        <span class="text-gray-400">Activity Level</span>
                        <div class="flex items-center space-x-2">
                            <div class="heat-gradient w-32 h-2 rounded"></div>
                            <span class="text-gray-400">Low</span>
                            <span class="text-gray-400">High</span>
                        </div>
                    </div>
                </div>
                
                <!-- Country Selection -->
                <div class="glass-effect rounded-xl p-6">
                    <h3 class="text-lg font-semibold mb-4">Select Your Country</h3>
                    <div class="flex flex-wrap gap-2">
                        <button class="country-btn px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors" data-country="HRV" data-name="Croatia">🇭🇷 Croatia</button>
                        <button class="country-btn px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors" data-country="DEU" data-name="Germany">🇩🇪 Germany</button>
                        <button class="country-btn px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors" data-country="USA" data-name="United States">🇺🇸 USA</button>
                        <button class="country-btn px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors" data-country="GBR" data-name="United Kingdom">🇬🇧 UK</button>
                        <button class="country-btn px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors" data-country="FRA" data-name="France">🇫🇷 France</button>
                        <button class="country-btn px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors" data-country="ITA" data-name="Italy">🇮🇹 Italy</button>
                        <button class="country-btn px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors" data-country="ESP" data-name="Spain">🇪🇸 Spain</button>
                        <button class="country-btn px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors" data-country="POL" data-name="Poland">🇵🇱 Poland</button>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Today's Leaders -->
                <div class="glass-effect rounded-xl p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        🔥 Today's Leaders
                    </h3>
                    <div id="leaders-list" class="space-y-3">
                        <div class="text-center text-gray-400 py-4">Loading leaders...</div>
                    </div>
                </div>
                
                <!-- Donation Form -->
                <div class="glass-effect rounded-xl p-6">
                    <h3 class="text-lg font-semibold mb-4">Make a Donation</h3>
                    <form id="donation-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Selected Country</label>
                            <div id="selected-country" class="p-3 bg-gray-800 rounded-lg text-center">
                                Click a country above
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Amount (EUR)</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button type="button" class="amount-btn p-3 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors" data-amount="5">€5</button>
                                <button type="button" class="amount-btn p-3 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors" data-amount="20">€20</button>
                                <button type="button" class="amount-btn p-3 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors" data-amount="50">€50</button>
                                <button type="button" class="amount-btn p-3 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors" data-amount="100">€100</button>
                            </div>
                            <input type="number" id="custom-amount" placeholder="Custom amount" class="w-full mt-2 p-3 bg-gray-800 rounded-lg border border-gray-600 focus:border-blue-500 focus:outline-none" min="1">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Referral (optional)</label>
                            <input type="text" id="referral-input" placeholder="@username" class="w-full p-3 bg-gray-800 rounded-lg border border-gray-600 focus:border-blue-500 focus:outline-none">
                        </div>
                        
                        <button type="submit" id="donate-btn" class="w-full p-4 bg-gradient-to-r from-blue-600 to-green-600 hover:from-blue-700 hover:to-green-700 rounded-lg font-semibold transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Donate Now
                        </button>
                    </form>
                </div>
                
                <!-- Top Captains -->
                <div class="glass-effect rounded-xl p-6">
                    <h3 class="text-lg font-semibold mb-4">🏆 Top Captains</h3>
                    <div id="captains-list" class="space-y-3">
                        <div class="text-center text-gray-400 py-4">Loading captains...</div>
                    </div>
                </div>
            </div>
        </div>
  </main>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Main App Script -->
    <script>
        class TapTheMapApp {
            constructor() {
                this.selectedCountry = null;
                this.selectedAmount = null;
                this.map = null;
                this.countryLayers = new Map();
                this.stats = {
                    totalDonations: 0,
                    totalCountries: 0,
                    totalDonors: 0
                };
                
                this.init();
            }
            
            async init() {
                this.setupEventListeners();
                await this.initializeMap();
                await this.loadStats();
                this.setupReferral();
            }
            
            setupEventListeners() {
                // Country selection
                document.querySelectorAll('.country-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const country = e.target.dataset.country;
                        const name = e.target.dataset.name;
                        this.selectCountry(country, name);
                    });
                });
                
                // Amount selection
                document.querySelectorAll('.amount-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const amount = parseInt(e.target.dataset.amount);
                        this.selectAmount(amount);
                    });
                });
                
                // Custom amount
                document.getElementById('custom-amount').addEventListener('input', (e) => {
                    const amount = parseInt(e.target.value);
                    if (amount > 0) {
                        this.selectAmount(amount);
                    }
                });
                
                // Donation form
                document.getElementById('donation-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.processDonation();
                });
                
                // Clear referral
                document.getElementById('clear-referral').addEventListener('click', () => {
                    this.clearReferral();
                });
            }
            
            selectCountry(country, name) {
                console.log('selectCountry called:', country, name);
                this.selectedCountry = { code: country, name: name };
                
                // Update UI
                document.getElementById('selected-country').innerHTML = `
                    <span class="text-lg">${this.getCountryFlag(country)} ${name}</span>
                `;
                
                // Update button states
                document.querySelectorAll('.country-btn').forEach(btn => {
                    btn.classList.remove('ring-2', 'ring-blue-400');
                    if (btn.dataset.country === country) {
                        btn.classList.add('ring-2', 'ring-blue-400');
                    }
                });
                
                this.updateDonateButton();
            }
            
            selectAmount(amount) {
                this.selectedAmount = amount;
                
                // Update button states
                document.querySelectorAll('.amount-btn').forEach(btn => {
                    btn.classList.remove('ring-2', 'ring-blue-400');
                    if (parseInt(btn.dataset.amount) === amount) {
                        btn.classList.add('ring-2', 'ring-blue-400');
                    }
                });
                
                this.updateDonateButton();
            }
            
            updateDonateButton() {
                const donateBtn = document.getElementById('donate-btn');
                const isReady = this.selectedCountry && this.selectedAmount;
                
                donateBtn.disabled = !isReady;
                if (isReady) {
                    donateBtn.textContent = `Donate €${this.selectedAmount}`;
                } else {
                    donateBtn.textContent = 'Select Country & Amount';
                }
            }
            
            async processDonation() {
                if (!this.selectedCountry || !this.selectedAmount) {
                    alert('Please select a country and amount');
                    return;
                }
                
                const referral = document.getElementById('referral-input').value.trim();
                
                try {
                    const response = await fetch('/.netlify/functions/checkout', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            amount_cents: this.selectedAmount * 100,
                            country_iso: this.selectedCountry.code,
                            country_name: this.selectedCountry.name,
                            ref: referral || '',
                            email: null
                        })
                    });
                    
                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(error);
                    }
                    
                    const data = await response.json();
                    if (data.url) {
                        window.location.href = data.url;
                    } else {
                        throw new Error('No checkout URL returned');
                    }
                } catch (error) {
                    console.error('Donation error:', error);
                    alert('Error processing donation: ' + error.message);
                }
            }
            
            async initializeMap() {
                // Initialize map
                this.map = L.map('map', {
                    zoomControl: false,
                    worldCopyJump: true
                }).setView([20, 0], 2);
                
                // Add tile layer
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; OpenStreetMap & CARTO',
                    detectRetina: true,
                    maxZoom: 6,
                    minZoom: 2
                }).addTo(this.map);
                
                // Load country data
                await this.loadCountryData();
                
                document.getElementById('map-status').textContent = 'Map loaded ✓';
            }
            
            async loadCountryData() {
                try {
                    // Try multiple sources
                    const sources = [
                        'https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson',
                        'https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson',
                        'https://raw.githubusercontent.com/hjstowers/geojson-world/master/countries.geojson'
                    ];
                    
                    let geoData = null;
                    for (const source of sources) {
                        try {
                            console.log('Trying source:', source);
                            const response = await fetch(source);
                            if (response.ok) {
                                geoData = await response.json();
                                console.log('Successfully loaded from:', source);
                                break;
                            }
                        } catch (e) {
                            console.log('Failed to load from:', source, e.message);
                        }
                    }
                    
                    if (!geoData) {
                        throw new Error('All sources failed');
                    }
                    
                    L.geoJSON(geoData, {
                        style: (feature) => this.getCountryStyle(feature),
                        onEachFeature: (feature, layer) => {
                            const countryCode = this.getCountryCode(feature.properties);
                            const countryName = this.getCountryName(feature.properties);
                            
                            this.countryLayers.set(countryCode, layer);
                            
                            // Add tooltip
                            layer.bindTooltip(`${this.getCountryFlag(countryCode)} ${countryName}`, {
                                sticky: true,
                                opacity: 0.9
                            });
                            
                            // Add click handler
                            layer.on('click', () => {
                                this.selectCountry(countryCode, countryName);
                            });
                            
                            // Add hover effects
                            layer.on('mouseover', (e) => {
                                e.target.setStyle({
                                    weight: 2,
                                    opacity: 1
                                });
                            });
                            
                            layer.on('mouseout', (e) => {
                                e.target.setStyle(this.getCountryStyle(feature));
                            });
                        }
                    }).addTo(this.map);
                    
                } catch (error) {
                    console.error('Error loading country data:', error);
                    document.getElementById('map-status').textContent = 'Map failed to load';
                }
            }
            
            getCountryStyle(feature) {
                const countryCode = this.getCountryCode(feature.properties);
                const heatValue = this.stats.countryData?.[countryCode] || 0;
                
                return {
                    fillColor: this.getHeatColor(heatValue),
                    weight: 1,
                    opacity: 1,
                    color: '#94a3b8',
                    dashArray: '3',
                    fillOpacity: 0.6
                };
            }
            
            getHeatColor(value) {
                if (value === 0) return '#374151';
                if (value < 50) return '#3b82f6';
                if (value < 200) return '#22c55e';
                if (value < 500) return '#f59e0b';
                return '#ef4444';
            }
            
            getCountryCode(properties) {
                console.log('Country properties:', properties);
                return (properties.ADM0_A3 || properties.ISO_A3 || properties.iso_a3 || properties.A3 || properties.ISO_A2 || properties.iso_a2 || '').toString().toUpperCase().slice(0, 3);
            }
            
            getCountryName(properties) {
                return properties.NAME_EN || properties.ADMIN || properties.NAME_LONG || properties.SOVEREIGNT || 'Unknown';
            }
            
            getCountryFlag(countryCode) {
                const flags = {
                    'HRV': '🇭🇷', 'DEU': '🇩🇪', 'USA': '🇺🇸', 'GBR': '🇬🇧',
                    'FRA': '🇫🇷', 'ITA': '🇮🇹', 'ESP': '🇪🇸', 'POL': '🇵🇱',
                    'IND': '🇮🇳', 'BRA': '🇧🇷', 'CHN': '🇨🇳', 'JPN': '🇯🇵',
                    'AUS': '🇦🇺', 'CAN': '🇨🇦', 'RUS': '🇷🇺', 'MEX': '🇲🇽',
                    'ARG': '🇦🇷', 'ZAF': '🇿🇦', 'EGY': '🇪🇬', 'GRL': '🇬🇱'
                };
                return flags[countryCode] || '🏳️';
            }
            
            async loadStats() {
                try {
                    const response = await fetch('/.netlify/functions/stats');
                    const data = await response.json();
                    
                    this.stats.countryData = {};
                    let totalDonations = 0;
                    let totalDonors = 0;
                    
                    data.forEach(country => {
                        this.stats.countryData[country.iso] = country.total_eur;
                        totalDonations += country.total_eur;
                        totalDonors += country.donors_24h;
                    });
                    
                    this.stats.totalDonations = totalDonations;
                    this.stats.totalCountries = data.length;
                    this.stats.totalDonors = totalDonors;
                    
                    this.updateStatsDisplay();
                    this.updateLeadersList(data);
                    this.updateMapColors();
                    
                } catch (error) {
                    console.error('Error loading stats:', error);
                }
            }
            
            updateStatsDisplay() {
                document.getElementById('total-donations').textContent = `€${this.stats.totalDonations.toFixed(0)}`;
                document.getElementById('total-countries').textContent = this.stats.totalCountries;
                document.getElementById('total-donors').textContent = this.stats.totalDonors;
            }
            
            updateLeadersList(data) {
                const leadersList = document.getElementById('leaders-list');
                
                if (data.length === 0) {
                    leadersList.innerHTML = '<div class="text-center text-gray-400 py-4">No donations yet. Be the first!</div>';
                    return;
                }
                
                const sortedData = data
                    .sort((a, b) => (b.donors_24h || 0) - (a.donors_24h || 0))
                    .slice(0, 5);
                
                leadersList.innerHTML = sortedData.map((country, index) => `
                    <div class="flex items-center justify-between p-3 bg-gray-800 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-gradient-to-r from-blue-600 to-green-600 rounded-full flex items-center justify-center text-sm font-bold">
                                ${index + 1}
                            </div>
                            <div>
                                <div class="font-semibold">${this.getCountryFlag(country.iso)} ${country.country_name || country.iso}</div>
                                <div class="text-xs text-gray-400">${country.donors_24h || 0} donors • €${(country.total_eur || 0).toFixed(0)}</div>
                            </div>
                        </div>
                        <button class="text-xs px-2 py-1 bg-blue-600 hover:bg-blue-700 rounded transition-colors" onclick="app.selectCountry('${country.iso}', '${country.country_name || country.iso}')">
                            Donate
                        </button>
                    </div>
                `).join('');
            }
            
            updateMapColors() {
                this.countryLayers.forEach((layer, countryCode) => {
                    const heatValue = this.stats.countryData?.[countryCode] || 0;
                    layer.setStyle({
                        fillColor: this.getHeatColor(heatValue),
                        fillOpacity: heatValue > 0 ? 0.8 : 0.3
                    });
                });
            }
            
            setupReferral() {
                const urlParams = new URLSearchParams(window.location.search);
                const referral = urlParams.get('r') || urlParams.get('ref');
                
                if (referral && referral !== 'yourhandle') {
                    this.selectedReferral = referral;
                    document.getElementById('referral-name').textContent = `@${referral}`;
                    document.getElementById('referral-badge').classList.remove('hidden');
                    document.getElementById('referral-input').value = referral;
                }
            }
            
            clearReferral() {
                this.selectedReferral = null;
                document.getElementById('referral-badge').classList.add('hidden');
                document.getElementById('referral-input').value = '';
            }
        }
        
        // Initialize app
        const app = new TapTheMapApp();
        
        // Auto-refresh stats every 30 seconds
        setInterval(() => {
            app.loadStats();
        }, 30000);
    </script>
</body>
</html>
