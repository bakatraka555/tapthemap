<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>tapthemap.world</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body{background:#0b1020;color:#fff}
    #map{height:60vh;min-height:420px}
    .card{backdrop-filter:blur(8px);background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:16px}
    .amt-btn{background:#1e40af;padding:.6rem 1rem;border-radius:12px}
    .amt-btn.active{outline:2px solid #22c55e;outline-offset:2px}
    .leaflet-container{background:#0b1020}
  </style>
</head>
<body class="antialiased">
  <main class="max-w-6xl mx-auto p-6">
    <h1 class="text-2xl md:text-4xl font-bold">Fill the map. Your country, your pride.</h1>
    <p class="opacity-80 mt-2">Click a country, choose amount, pay securely via Stripe. We use your clicked country, not your card’s billing country.</p>

    <div id="map" class="card mt-6"></div>

    <!-- Donate modal -->
    <div id="donateModal" class="fixed inset-0 z-40 hidden">
      <div class="absolute inset-0 bg-black/60"></div>
      <div class="relative z-10 max-w-2xl mx-auto mt-24">
        <div class="bg-white text-slate-900 rounded-2xl shadow-2xl border border-slate-200">
          <div class="p-5 border-b border-slate-200 flex items-center justify-between">
            <div>
              <div class="text-xs uppercase tracking-wide text-slate-500">Supporting</div>
              <div id="modalCountry" class="text-xl font-bold">—</div>
            </div>
            <button id="closeModal" class="p-2 text-slate-600 hover:text-slate-900">✕</button>
          </div>
          <div class="p-6 grid md:grid-cols-[1fr_180px] gap-6">
            <div>
              <div class="flex flex-wrap gap-3">
                <button class="amt-btn text-white" data-amt="5">5 €</button>
                <button class="amt-btn text-white" data-amt="20">20 €</button>
                <button class="amt-btn text-white" data-amt="50">50 €</button>
                <button class="amt-btn text-white" data-amt="100">100 €</button>
                <div class="flex items-center gap-2 bg-slate-100 rounded-xl px-3 py-2">
                  <input id="otherAmt" type="number" min="2" step="1" placeholder="Other" class="w-24 bg-transparent outline-none text-slate-800"/>
                  <button id="otherOk" class="text-blue-700 font-semibold">OK</button>
                </div>
              </div>
              <p class="text-sm text-slate-600 mt-3">Private gift. Anonymous option. Apple/Google Pay supported.</p>
            </div>
            <div>
              <div class="rounded-xl border border-slate-200 p-3 grid place-items-center h-[150px] text-slate-500">
                <div>Checkout link will open Stripe</div>
              </div>
              <button id="payNow" class="mt-3 w-full bg-emerald-600 hover:bg-emerald-500 text-white font-semibold px-4 py-2.5 rounded-xl">Pay now</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <ul id="todayList" class="card p-5 mt-6"></ul>
  </main>

  <script>
    // ---- 1) GLOBAL STATE: kliknuta država i iznos
    let selectedCountry = null; // { iso3:'FIN', name:'Finland' }
    let selectedAmount = 20;

    const modal = document.getElementById('donateModal');
    const modalCountry = document.getElementById('modalCountry');
    const payNow = document.getElementById('payNow');
    const closeModal = document.getElementById('closeModal');

    // ---- 2) MAPA: klik na poligon postavlja selectedCountry
    const map = L.map('map', { zoomControl: false }).setView([20,0], 2);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom:6, minZoom:2, attribution:'&copy; OSM & CARTO' }).addTo(map);

    const SOURCES = [
      'https://cdn.jsdelivr.net/npm/@geo-maps/countries-land-10m@1.0.1/countries-land-10m.geo.json',
      'https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson'
    ];
    const isoFrom  = (p) => (p.ADM0_A3 || p.ISO_A3 || p.iso_a3 || p.SOV_A3 || p.id || '').toString().toUpperCase().slice(0,3);
    const nameFrom = (p) => (p.NAME_EN || p.ADMIN || p.NAME_LONG || p.SOVEREIGNT || p.name || 'Unknown');

    async function fetchAny(urls){
      for (const u of urls){
        try { const r = await fetch(u, { cache:'no-store' }); if(!r.ok) throw 0; return await r.json(); } catch {}
      }
      throw new Error('World failed to load');
    }

    fetchAny(SOURCES).then(geo=>{
      const world = L.geoJSON(geo, {
        style: ()=>({ color:'#94a3b8', weight:.7, fillColor:'#0ea5e9', fillOpacity:.12 }),
        onEachFeature: (f, layer) => {
          const iso = isoFrom(f.properties);
          const name = nameFrom(f.properties);

          layer.bindTooltip(name, { sticky:true, opacity:.95 });
          layer.on({
            mouseover: (e)=>{ e.target.setStyle({ weight:1.3 }); },
            mouseout:  (e)=>{ e.target.setStyle({ weight:.7 }); },
            click:     ()=>{
              selectedCountry = { iso3: iso, name };
              modalCountry.textContent = name;
              openModal();
            }
          });
        }
      }).addTo(map);
      window.worldLayer = world; // ako treba drugdje
    }).catch(()=>{ /* noop */ });

    function openModal(){ modal.classList.remove('hidden'); }
    closeModal.addEventListener('click', ()=> modal.classList.add('hidden'));

    // ---- 3) IZNOSI: klik označi aktivan i postavi selectedAmount (min €2)
    function setActive(btn){
      document.querySelectorAll('.amt-btn').forEach(b=>b.classList.remove('active'));
      if (btn) btn.classList.add('active');
    }
    document.querySelectorAll('.amt-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        selectedAmount = Math.max(2, Number(btn.dataset.amt||0));
        setActive(btn);
      });
    });
    document.getElementById('otherOk').addEventListener('click', ()=>{
      const v = Math.max(2, Number(document.getElementById('otherAmt').value||0));
      if(!v) return alert('Enter amount ≥ €2');
      selectedAmount = v; setActive(null);
    });

    // ---- 4) PAY NOW: šalje ISKLJUČIVO kliknutu državu u /checkout
    payNow.addEventListener('click', async ()=>{
      if (!selectedCountry || !selectedCountry.iso3) {
        alert('Click a country on the map first.'); return;
      }
      if (!selectedAmount || selectedAmount < 2) {
        alert('Choose amount (min €2).'); return;
      }

      const payload = {
        country_iso: selectedCountry.iso3,     // ⇦ iz klika
        country_name: selectedCountry.name,    // ⇦ iz klika
        amount_eur: selectedAmount,
        ref: localStorage.getItem('ttm_ref') || '',
        handle: ''
      };
      console.log('CHECKOUT payload', payload);

      try{
        const r = await fetch('/.netlify/functions/checkout', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const out = await r.json().catch(()=> ({}));
        if (!r.ok || !out.url) { alert('Checkout error'); return; }
        location.href = out.url;
      }catch(e){ alert('Network error'); }
    });

    // ---- 5) (opcionalno) Today list placeholder
    (async function loadToday(){
      try{
        const r = await fetch('/.netlify/functions/stats', { cache:'no-store' });
        const arr = await r.json();
        document.getElementById('todayList').innerHTML =
          (arr||[]).slice(0,10).map(x=>`<li class="py-1 flex justify-between">${x.name||x.country_name} <b>€${Number(x.total_eur||0).toFixed(0)}</b></li>`).join('') || '<li>No data yet.</li>';
      }catch{ document.getElementById('todayList').textContent='—'; }
    })();
  </script>
</body>
</html>
