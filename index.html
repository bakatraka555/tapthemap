<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TapTheMap ‚Äî Influencers Battle</title>
  <meta name="description" content="Tap your country, back your captain, and light up the map. Secure by Stripe ¬∑ SSL ¬∑ Anonymous possible." />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] },
          colors: { ink:{900:'#0b1020'} }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Fallback da nije blijedo i bez Tailwinda -->
  <style>
    html,body{height:100%}
    body{background:#0b1020;color:#fff;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    #map{height:62vh;min-height:420px}
    .card{backdrop-filter:blur(8px);background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:18px}
  </style>
</head>
<body class="bg-ink-900 text-white antialiased">
  <!-- Header -->
  <header class="sticky top-0 z-30">
    <div class="mx-auto max-w-7xl px-6 pt-5">
      <div class="card px-5 py-4 flex items-center justify-between">
        <a href="/" class="text-xl md:text-2xl font-bold tracking-tight">tapthemap.world</a>
        <nav class="hidden md:flex items-center gap-8 text-slate-200/90">
          <a href="#leaders" class="hover:text-white">Leaders</a>
          <a href="#about" class="hover:text-white">About</a>
          <a href="#faq" class="hover:text-white">FAQ</a>
        </nav>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main>
    <section class="mx-auto max-w-7xl px-6">
      <div class="grid lg:grid-cols-[1fr_380px] gap-6 mt-10">
        <!-- Left -->
        <div>
          <div class="mb-6">
            <h1 class="text-3xl md:text-5xl font-bold leading-tight">Fill the map. Your country, your pride.</h1>
            <p class="mt-4 text-slate-300 max-w-2xl">
              Tap your country and choose 5 / 20 / 50 / 100 ‚Ç¨ or ‚ÄúOther‚Äù.
              Every contribution lights up your land.
              <span class="text-slate-200">Secure by Stripe ¬∑ SSL ¬∑ Anonymous option.</span>
            </p>
            <div class="mt-5 flex items-center gap-3 text-slate-300 text-sm">
              <span class="inline-flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span> Live
              </span>
              <span>¬∑</span>
              <span>Apple/Google Pay supported</span>
            </div>
          </div>

          <div class="flex items-center gap-3 mb-3">
            <label for="countrySelect" class="text-sm text-slate-300">Country:</label>
            <select id="countrySelect" class="bg-white/10 border border-white/10 rounded-xl px-3 py-2 text-sm focus:outline-none">
              <option value="HRV|Croatia">Croatia (HRV)</option>
              <option value="DEU|Germany">Germany (DEU)</option>
              <option value="USA|United States">United States (USA)</option>
              <option value="GBR|United Kingdom">United Kingdom (GBR)</option>
              <option value="FRA|France">France (FRA)</option>
              <option value="ITA|Italy">Italy (ITA)</option>
              <option value="ESP|Spain">Spain (ESP)</option>
              <option value="POL|Poland">Poland (POL)</option>
              <option value="IND|India">India (IND)</option>
              <option value="BRA|Brazil">Brazil (BRA)</option>
            </select>
            <button id="openDonate" class="inline-flex items-center gap-2 bg-emerald-600 hover:bg-emerald-500 text-white font-semibold px-4 py-2 rounded-xl">
              Donate
            </button>
          </div>

          <!-- Map (dark) -->
          <div id="map" class="card overflow-hidden"></div>
        </div>

        <!-- Right -->
        <aside class="lg:sticky lg:top-28">
          <div class="card p-5">
            <div class="flex items-center justify-between">
              <h2 class="text-xl font-semibold">üî• Today‚Äôs heat</h2>
              <a href="#leaders" class="text-sm text-slate-300 hover:text-white">Leaders ‚Üí</a>
            </div>
            <ul id="todayList" class="mt-4 space-y-4">
              <li class="text-slate-400 text-sm">Loading live stats‚Ä¶</li>
            </ul>
            <div class="mt-5 text-sm text-slate-300">We display @handles only with consent. Anonymous is possible.</div>
          </div>

          <div class="card p-5 mt-6">
            <h3 class="text-lg font-semibold">Become a Captain</h3>
            <p class="text-slate-300 mt-2">Apply and get your referral link. Weekly Captain = most unique donors.</p>
            <a href="/join" class="mt-3 inline-flex items-center bg-emerald-600 hover:bg-emerald-500 px-4 py-2 rounded-xl font-semibold">Apply ‚Üí</a>
          </div>
        </aside>
      </div>
    </section>
  </main>

  <!-- Donate Modal -->
  <div id="donateModal" class="fixed inset-0 z-40 hidden">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="relative z-10 max-w-2xl mx-auto mt-24">
      <div class="bg-white text-slate-900 rounded-2xl shadow-2xl border border-slate-200">
        <div class="p-6 border-b border-slate-200 flex items-center justify-between">
          <div>
            <div id="modalCountry" class="text-xl font-bold">Croatia</div>
            <div class="text-sm text-slate-600">Choose amount</div>
          </div>
          <button id="closeModal" class="p-2 text-slate-500 hover:text-slate-800">‚úï</button>
        </div>
        <div class="p-6 grid md:grid-cols-[1fr_160px] gap-6">
          <div>
            <div class="flex flex-wrap gap-3">
              <button data-amt="5" class="amt-btn bg-blue-600 hover:bg-blue-500 text-white font-semibold px-5 py-2.5 rounded-xl">5 ‚Ç¨</button>
              <button data-amt="20" class="amt-btn bg-blue-600 hover:bg-blue-500 text-white font-semibold px-5 py-2.5 rounded-xl">20 ‚Ç¨</button>
              <button data-amt="50" class="amt-btn bg-blue-600 hover:bg-blue-500 text-white font-semibold px-5 py-2.5 rounded-xl">50 ‚Ç¨</button>
              <button data-amt="100" class="amt-btn bg-blue-600 hover:bg-blue-500 text-white font-semibold px-5 py-2.5 rounded-xl">100 ‚Ç¨</button>
              <div class="flex items-center gap-2 bg-slate-100 rounded-xl px-3 py-2">
                <input id="otherAmt" type="number" min="1" step="1" placeholder="Other" class="w-24 bg-transparent outline-none text-slate-800" />
                <button id="otherBtn" class="text-blue-700 font-semibold">OK</button>
              </div>
            </div>
            <div class="mt-4 text-sm text-slate-600">Private gift, no quid pro quo. We show @handles only with consent.</div>
          </div>
          <div>
            <div class="rounded-xl border border-slate-200 p-3 grid place-items-center h-[150px] text-slate-500">
              <div id="qrBox">QR will appear after creating the Checkout link</div>
            </div>
            <button id="payNow" class="mt-3 w-full bg-emerald-600 hover:bg-emerald-500 text-white font-semibold px-4 py-2.5 rounded-xl">Pay now</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    // ----- State -----
    const modal = document.getElementById('donateModal');
    const openDonateBtn = document.getElementById('openDonate');
    const closeBtn = document.getElementById('closeModal');
    const payNow = document.getElementById('payNow');
    const modalCountry = document.getElementById('modalCountry');
    const countrySelect = document.getElementById('countrySelect');
    const todayList = document.getElementById('todayList');

    const qs = new URLSearchParams(location.search);
    const initialISO = qs.get('c') || 'HRV';
    const initialRef = qs.get('ref') || '';
    const isoToName = { HRV:'Croatia', DEU:'Germany', USA:'United States', GBR:'United Kingdom', FRA:'France', ITA:'Italy', ESP:'Spain', POL:'Poland', IND:'India', BRA:'Brazil' };

    let chosen = { country_iso: initialISO, country_name: isoToName[initialISO] || initialISO, amount: 20, ref: initialRef };
    function openModal(){ modal.classList.remove('hidden'); modalCountry.textContent = chosen.country_name; }
    function closeModal(){ modal.classList.add('hidden'); }

    // ----- Leaflet (dark tiles) -----
    const map = L.map('map', { zoomControl:false, worldCopyJump:true }).setView([20,0], 2);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution:'&copy; OpenStreetMap & CARTO', detectRetina:true, maxZoom:6, minZoom:2
    }).addTo(map);
    map.on('click', openModal);

    // ----- UI -----
    document.getElementById('openDonate').addEventListener('click', openModal);
    closeBtn.addEventListener('click', closeModal);

    document.querySelectorAll('.amt-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        chosen.amount = parseInt(btn.dataset.amt,10);
        document.querySelectorAll('.amt-btn').forEach(b=>b.classList.remove('ring','ring-offset-2'));
        btn.classList.add('ring','ring-offset-2');
      });
    });
    document.getElementById('otherBtn').addEventListener('click', ()=>{
      const v = parseInt(document.getElementById('otherAmt').value,10);
      if(v>0) chosen.amount = v;
    });

    countrySelect.addEventListener('change', ()=>{
      const [iso,name] = countrySelect.value.split('|');
      chosen.country_iso = iso; chosen.country_name = name;
      modalCountry.textContent = name;
    });
    countrySelect.value = `${chosen.country_iso}|${chosen.country_name}`;

    // ----- Pay now ‚Üí Checkout -----
    payNow.addEventListener('click', async ()=>{
      try {
        const res = await fetch('/.netlify/functions/checkout', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(chosen) // { country_iso, country_name, amount, ref }
        });
        if (res.status === 503) { alert('Payments are not configured yet. Add STRIPE keys in Netlify ENV.'); return; }
        if (!res.ok) { const t = await res.text(); alert('Checkout error: ' + t); return; }
        const { url } = await res.json();
        if (url) location.href = url; else alert('No checkout URL returned.');
      } catch { alert('Network error.'); }
    });

    // ----- Today‚Äôs heat (stats) -----
    async function loadStats(){
      try {
        const res = await fetch('/.netlify/functions/stats', { cache:'no-store' });
        if (!res.ok) throw 0;
        const data = await res.json();
        if (!Array.isArray(data) || !data.length) {
          todayList.innerHTML = `<li class="text-slate-400 text-sm">No data yet ‚Äî be the first to light up your country.</li>`;
          return;
        }
        data.sort((a,b)=> (b.donors_24h - a.donors_24h) || (parseFloat(b.total_eur)-parseFloat(a.total_eur)));
        todayList.innerHTML = data.slice(0,5).map(row=>{
          const name = isoToName[row.iso] || row.iso;
          return `<li class="flex items-center justify-between">
            <div class="flex items-center gap-3"><span class="font-semibold">${name}</span></div>
            <div class="text-blue-300">‚Ç¨${row.total_eur}</div>
          </li>`;
        }).join('');
      } catch {
        todayList.innerHTML = `<li class="text-slate-400 text-sm">Stats temporarily unavailable.</li>`;
      }
    }
    loadStats();
    setInterval(loadStats, 20000);
  </script>
</body>
</html>
