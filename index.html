<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TapTheMap ‚Äî Light up your country</title>
<meta name="description" content="Tap your country, pick an amount, and light up the map. Secure Stripe checkout.">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  html,body{height:100%} body{background:#0b1020;color:#fff;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .card{backdrop-filter:blur(8px);background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:18px}
  #map{height:62vh;min-height:420px}
  .flag{width:22px;height:16px;border-radius:3px;border:1px solid rgba(255,255,255,.25);object-fit:cover}
  .amt-selected{outline:2px solid #22c55e;outline-offset:2px}
  .leaflet-container{background:#0b1020}
</style>
</head>
<body class="bg-slate-950">
<header class="sticky top-0 z-30">
  <div class="mx-auto max-w-7xl px-6 pt-5">
    <div class="card px-5 py-4 flex items-center justify-between">
      <a class="text-xl md:text-2xl font-bold" href="/">tapthemap.world</a>
      <div id="refBar" class="hidden text-sm">
        <span class="px-2.5 py-1 rounded-full bg-emerald-700/40 border border-emerald-400/40">
          Supporting <b id="refName"></b>
        </span>
      </div>
    </div>
  </div>
</header>

<main class="mx-auto max-w-7xl px-6">
  <div class="grid lg:grid-cols-[1fr_380px] gap-6 mt-8">
    <section>
      <h1 class="text-3xl md:text-5xl font-bold leading-tight">Fill the map. Your country, your pride.</h1>
      <p class="mt-3 text-slate-300">Tap a country and pick 5 / 20 / 50 / 100 ‚Ç¨ or ‚ÄúOther‚Äù. Stripe-secured. Anonymous available.</p>

      <div id="map" class="card mt-6"></div>
      <div id="mapMsg" class="mt-2 text-sm text-lime-300/90">Loading world‚Ä¶</div>
    </section>

    <aside class="lg:sticky lg:top-24">
      <div class="card p-5">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold">üî• Today‚Äôs heat</h2>
        </div>
        <ul id="todayList" class="mt-4 space-y-3">
          <li class="text-slate-400 text-sm">Fetching stats‚Ä¶</li>
        </ul>
      </div>

      <div id="leadersCard" class="card p-5 mt-6">
        <h3 class="text-lg font-semibold">Top Captains (7d)</h3>
        <ul id="leadersList" class="mt-4 space-y-3">
          <li class="text-slate-400 text-sm">Loading‚Ä¶</li>
        </ul>
      </div>
    </aside>
  </div>
</main>

<!-- Modal -->
<div id="donateModal" class="fixed inset-0 z-40 hidden">
  <div class="absolute inset-0 bg-black/60"></div>
  <div class="relative z-10 max-w-2xl mx-auto mt-24">
    <div class="bg-white text-slate-900 rounded-2xl shadow-xl border border-slate-200">
      <div class="p-6 border-b border-slate-200 flex items-center justify-between">
        <div>
          <div id="modalCountry" class="text-xl font-bold">Country</div>
          <div class="text-sm text-slate-600">Choose amount</div>
        </div>
        <button id="closeModal" class="p-2 text-slate-500 hover:text-slate-800">‚úï</button>
      </div>
      <div class="p-6 grid md:grid-cols-[1fr_160px] gap-6">
        <div>
          <div class="flex flex-wrap gap-3">
            <button class="amt-btn bg-blue-600 hover:bg-blue-500 text-white font-semibold px-5 py-2.5 rounded-xl" data-amt="5">5 ‚Ç¨</button>
            <button class="amt-btn bg-blue-600 hover:bg-blue-500 text-white font-semibold px-5 py-2.5 rounded-xl" data-amt="20">20 ‚Ç¨</button>
            <button class="amt-btn bg-blue-600 hover:bg-blue-500 text-white font-semibold px-5 py-2.5 rounded-xl" data-amt="50">50 ‚Ç¨</button>
            <button class="amt-btn bg-blue-600 hover:bg-blue-500 text-white font-semibold px-5 py-2.5 rounded-xl" data-amt="100">100 ‚Ç¨</button>
            <div class="flex items-center gap-2 bg-slate-100 rounded-xl px-3 py-2">
              <input id="otherAmt" type="number" min="1" step="1" placeholder="Other" class="w-24 bg-transparent outline-none text-slate-800">
              <button id="otherBtn" class="text-blue-700 font-semibold">OK</button>
            </div>
          </div>
          <div class="mt-3 text-sm text-slate-600">We only show @handles when you append <b>?r=yourhandle</b> to the URL.</div>
        </div>
        <div>
          <div class="rounded-xl border border-slate-200 p-3 grid place-items-center h-[150px] text-slate-500">Stripe opens on Pay</div>
          <button id="payNow" class="mt-3 w-full bg-emerald-600 hover:bg-emerald-500 text-white font-semibold px-4 py-2.5 rounded-xl">Pay now</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== helpers ===== */
const euro = (n)=>'‚Ç¨'+Number(n||0).toLocaleString('en-US',{maximumFractionDigits:0});
const getParam=(k)=>new URLSearchParams(location.search).get(k);
const sanitize=(s)=>(s||'').toString().replace(/[^a-zA-Z0-9_.-]/g,'').slice(0,32);
const flagURL=(iso2)=>`https://flagcdn.com/w40/${iso2.toLowerCase()}.png`;

/* ===== ref bar (samo ako je ?r= u URL-u) ===== */
(function(){
  const r = sanitize(getParam('r'));
  if (r) {
    document.getElementById('refBar').classList.remove('hidden');
    document.getElementById('refName').textContent='@'+r;
  }
})();

/* ===== global state ===== */
let chosen = { iso:'', name:'', amount:20, ref: sanitize(getParam('r')) || '' };

/* ===== Leaflet mapa ===== */
const map = L.map('map',{zoomControl:false, worldCopyJump:true, tap:false}).setView([20,0],2);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{maxZoom:6,minZoom:2,detectRetina:true}).addTo(map);
const GEO_URLS = [
  'https://cdn.jsdelivr.net/npm/@geo-maps/countries-land-10m@1.0.1/countries-land-10m.geo.json',
  'https://unpkg.com/@geo-maps/countries-land-10m@1.0.1/countries-land-10m.geo.json',
  'https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson'
];
const iso3 = (p)=>(p.ADM0_A3||p.ISO_A3||p.iso_a3||p.SOV_A3||p.id||'').toString().toUpperCase().slice(0,3);
const iso2 = (p)=>(p.ISO_A2||p.iso_a2||'').toString().toUpperCase().slice(0,2);
const nameFrom = (p)=>(p.NAME_EN||p.ADMIN||p.NAME||p.name||'Unknown');
const layers = new Map();
const iso3to2 = {}; // popunit ƒáemo iz geojsona

function hsl(h,s,l){s/=100;l/=100;const k=n=>(n+h/30)%12;const a=s*Math.min(l,1-l);const f=n=>l-a*Math.max(-1,Math.min(k(n)-3,Math.min(9-k(n),1)));const x=t=>Math.round(255*t).toString(16).padStart(2,'0');return `#${x(f(0))}${x(f(8))}${x(f(4))}`;}
function styleFor(v,min,max){ if(!max||v<=0) return {color:'#64748b',weight:.6,fillColor:'#0ea5e9',fillOpacity:.08};
  const t=Math.max(0,Math.min(1,(v-min)/(max-min)));
  return {color:'#16a34a',weight:1,fillColor:hsl(195-195*t,85,50),fillOpacity:.55};
}

async function fetchAny(urls){let last; for(const u of urls){try{const r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw new Error(r.status); return await r.json();}catch(e){last=e}} throw last||new Error('geo fail');}

let totals = {}; let minVal=0, maxVal=0;
function applyChoropleth(){
  const vals=Object.values(totals).filter(Number.isFinite); maxVal=vals.length?Math.max(...vals):0; minVal=vals.length?Math.min(...vals):0;
  layers.forEach((lyr,iso)=>{ const v=Number(totals[iso]||0); lyr.setStyle(styleFor(v,minVal,maxVal));
    const nm = lyr.feature?.properties ? nameFrom(lyr.feature.properties) : iso;
    lyr.bindTooltip(v>0?`${nm} ¬∑ ${euro(v)}`:nm,{sticky:true,opacity:.95});
  });
}

/* Uƒçitavanje mape */
fetchAny(GEO_URLS).then(geo=>{
  L.geoJSON(geo,{style:()=>({color:'#64748b',weight:.6,fillColor:'#0ea5e9',fillOpacity:.08}),
    onEachFeature:(f,lyr)=>{
      const i3=iso3(f.properties); const n=nameFrom(f.properties); const i2=iso2(f.properties);
      if(i3) layers.set(i3,lyr); if(i3 && i2) iso3to2[i3]=i2;
      lyr.on({
        mouseover:(e)=>{e.target.setStyle({...e.target.options,weight:1.2}); map.getContainer().style.cursor='pointer';},
        mouseout:(e)=>{const v=Number(totals[i3]||0); e.target.setStyle(styleFor(v,minVal,maxVal)); map.getContainer().style.cursor='';},
        click:()=>{ chosen.iso=i3; chosen.name=n; openModal(n); }
      });
    }
  }).addTo(map);
  document.getElementById('mapMsg').textContent='World ready ‚úì';
  refreshStats(); refreshLeaders();
}).catch(()=>{ document.getElementById('mapMsg').textContent='World failed to load'; });

/* ===== modal & amounts ===== */
const modal = document.getElementById('donateModal');
const payNow = document.getElementById('payNow');
const closeModal = document.getElementById('closeModal');
function openModal(name){ document.getElementById('modalCountry').textContent=name||chosen.name||'Country'; modal.classList.remove('hidden'); setSelected(document.querySelector('.amt-btn[data-amt="20"]')); chosen.amount=20; }
function closeM(){ modal.classList.add('hidden'); }
closeModal.addEventListener('click',closeM);

function setSelected(btn){ document.querySelectorAll('.amt-btn').forEach(b=>b.classList.remove('amt-selected')); if(btn) btn.classList.add('amt-selected'); }
document.querySelectorAll('.amt-btn').forEach(b=>b.addEventListener('click',()=>{ chosen.amount=Number(b.dataset.amt||5); setSelected(b); }));
document.getElementById('otherBtn').addEventListener('click',()=>{ const v=Number(document.getElementById('otherAmt').value||0); if(v>0){ chosen.amount=v; setSelected(null);} });

payNow.addEventListener('click', async ()=>{
  try{
    if(!chosen.iso || !chosen.name){ alert('Pick a country on the map.'); return; }
    const payload = { country_iso: chosen.iso, country_name: chosen.name, amount_eur: Number(chosen.amount||5), ref: chosen.ref||'' };
    const res = await fetch('/.netlify/functions/checkout?t='+Date.now(), { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(!res.ok){ alert('Checkout error: '+await res.text()); return; }
    const { url } = await res.json(); if(url) location.href = url;
  }catch(e){ alert('Network error.'); }
});

/* ===== stats & leaders ===== */
async function refreshStats(){
  try{
    const r = await fetch('/.netlify/functions/stats?t='+Date.now(), { cache:'no-store' });
    if(!r.ok) throw new Error(await r.text());
    const arr = await r.json(); // [{iso,name,total_eur,donors_24h,donors_7d}]
    // puni totals i listu
    totals = {}; for(const it of arr){ totals[(it.iso||'').toUpperCase()] = Number(it.total_eur||0); }
    applyChoropleth();

    const top = [...arr].sort((a,b)=> (b.donors_24h-a.donors_24h) || (b.total_eur-a.total_eur)).slice(0,10);
    const list = document.getElementById('todayList');
    if(!top.length){ list.innerHTML = `<li class="text-slate-400 text-sm">No activity yet.</li>`; return; }
    list.innerHTML = top.map(it=>{
      const iso = (it.iso||'').toUpperCase(); const nm = it.name || iso;
      const a2 = iso3to2[iso];
      const flag = a2 ? `<img class="flag" src="${flagURL(a2)}" alt="${a2}">` : `<span class="inline-flex w-8 h-6 items-center justify-center rounded bg-emerald-700/30 border border-emerald-400/30 text-xs">${iso}</span>`;
      return `<li class="flex items-center justify-between">
        <div class="flex items-center gap-3">${flag}<div>
          <div class="font-semibold">${nm}</div>
          <div class="text-xs text-slate-400">${it.donors_24h} donors ¬∑ ${euro(it.total_eur)}</div>
        </div></div>
        <button class="text-sm px-3 py-1 rounded-lg bg-blue-600 hover:bg-blue-500" onclick="(function(){chosen.iso='${iso}'; chosen.name='${nm.replace(/'/g,'&#39;')}'; openModal('${nm.replace(/'/g,'&#39;')}');})()">Donate</button>
      </li>`;
    }).join('');
  }catch(e){
    document.getElementById('todayList').innerHTML = `<li class="text-slate-400 text-sm">Stats unavailable.</li>`;
  }finally{
    setTimeout(refreshStats, 20000);
  }
}

async function refreshLeaders(){
  try{
    const r = await fetch('/.netlify/functions/leaders?window=7d&limit=10&t='+Date.now(), { cache:'no-store' });
    if(!r.ok) throw new Error(await r.text());
    const json = await r.json(); const rows = json.by_ref || [];
    const ul = document.getElementById('leadersList');
    if(!rows.length){ ul.innerHTML = `<li class="text-slate-400 text-sm">No captains yet. Share your link with ?r=yourhandle</li>`; return; }
    ul.innerHTML = rows.map((it,i)=>{
      const countries = (it.countries||[]).slice(0,3).join(', ')+( (it.countries||[]).length>3 ? '‚Ä¶':'' );
      return `<li class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="inline-flex w-8 h-8 rounded-full bg-emerald-600/25 items-center justify-center border border-emerald-400/40 text-sm">${i+1}</span>
          <div>
            <div class="font-semibold">@${it.ref}</div>
            <div class="text-xs text-slate-400">${it.donors_unique} unique ¬∑ ${euro(it.total_eur)} ¬∑ ${countries}</div>
          </div>
        </div>
        <a class="text-sm px-3 py-1 rounded-lg bg-blue-600 hover:bg-blue-500" href="/?r=${encodeURIComponent(it.ref)}">Support</a>
      </li>`;
    }).join('');
  }catch(e){
    document.getElementById('leadersList').innerHTML = `<li class="text-slate-400 text-sm">Leaders unavailable.</li>`;
  }finally{
    setTimeout(refreshLeaders, 30000);
  }
}
</script>
</body>
</html>
