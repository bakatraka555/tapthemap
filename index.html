<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TapTheMap ‚Äî Fill the map</title>
  <meta name="description" content="Tap your country, choose an amount, pay with Stripe. Lights up the global heatmap." />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] } } } };
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html,body{height:100%}
    body{background:#0b1020;color:#fff;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    #map{height:62vh;min-height:420px}
    .card{backdrop-filter:blur(8px);background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,0.12);border-radius:18px}
    .leaflet-container{background:#0b1020}
    select{color:#fff!important;background-color:rgba(255,255,255,.1)!important;border:1px solid rgba(255,255,255,.15)!important}
    select:focus{outline:none;border-color:rgba(255,255,255,.35)!important}
    select option{color:#fff;background:#0b1020}
    .mini{font-variant-numeric: tabular-nums}
  </style>
</head>
<body class="bg-[#0b1020] text-white antialiased">
  <header class="sticky top-0 z-30">
    <div class="mx-auto max-w-7xl px-6 pt-5">
      <div class="card px-5 py-4 flex items-center justify-between">
        <a href="/" class="text-xl md:text-2xl font-bold tracking-tight">tapthemap.world</a>
        <nav class="flex items-center gap-3 text-sm text-slate-300">
          <a href="#how" class="hover:text-white">How it works</a>
          <a href="/.netlify/functions/stats" target="_blank" class="hover:text-white">/stats</a>
          <a href="/.netlify/functions/leaders?by=countries&window=7d" target="_blank" class="hover:text-white">/leaders</a>
        </nav>
      </div>
    </div>
  </header>

  <main>
    <section class="mx-auto max-w-7xl px-6">
      <div class="grid lg:grid-cols-[1fr_380px] gap-6 mt-10">
        <div>
          <div class="mb-6">
            <h1 class="text-3xl md:text-5xl font-bold leading-tight">Fill the map. Your country, your pride.</h1>
            <p class="mt-4 text-slate-300 max-w-2xl">Tap a country and pick 5 / 20 / 50 / 100 ‚Ç¨ or ‚ÄúOther‚Äù. Secure by Stripe. Anonymous option.</p>
            <div class="mt-5 flex items-center gap-3 text-slate-300 text-sm">
              <span class="inline-flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span><span>Live</span></span>
              <span class="opacity-70">¬∑</span>
              <span>Heat updates every 20 s</span>
            </div>
          </div>

          <div class="grid sm:grid-cols-[1fr_auto] gap-4 items-start">
            <div class="card p-4">
              <div class="flex flex-wrap items-center gap-3">
                <label for="countrySelect" class="text-sm opacity-80">Country</label>
                <select id="countrySelect" class="rounded-lg px-3 py-2 min-w-[220px]"></select>
                <div class="flex items-center gap-2 ml-auto">
                  <button data-amt="5" class="amt btn px-3 py-1.5 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10">‚Ç¨5</button>
                  <button data-amt="20" class="amt btn px-3 py-1.5 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10">‚Ç¨20</button>
                  <button data-amt="50" class="amt btn px-3 py-1.5 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10">‚Ç¨50</button>
                  <button data-amt="100" class="amt btn px-3 py-1.5 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10">‚Ç¨100</button>
                  <div class="flex items-center gap-2">
                    <span class="opacity-70">Other</span>
                    <input id="otherAmt" type="number" min="1" step="1" placeholder="20" aria-label="Other" class="w-24 bg-transparent outline-none text-slate-200 border border-white/10 rounded-lg px-2 py-1" />
                  </div>
                  <button id="openModal" class="ml-2 bg-emerald-400 text-black font-semibold px-4 py-2 rounded-xl">
                    Donate
                  </button>
                </div>
              </div>
            </div>

            <div class="hidden sm:block"></div>
          </div>

          <div id="map" class="card overflow-hidden relative z-0"></div>
          <div id="mapStatus" class="mt-2 text-xs text-emerald-300">Loading world‚Ä¶</div>
          <div id="legend" class="mt-2 text-xs text-slate-300 flex items-center gap-3 flex-wrap"></div>
        </div>

        <aside class="lg:sticky lg:top-28">
          <div class="card p-5">
            <div class="flex items-center justify-between">
              <h2 class="text-xl font-semibold">üî• Today‚Äôs heat</h2>
              <a href="/.netlify/functions/leaders?by=countries&window=7d" target="_blank" class="text-sm text-slate-300 hover:text-white">Leaders API ‚Üí</a>
            </div>
            <ul id="todayList" class="mt-4 space-y-4">
              <li class="text-slate-400 text-sm">Fetching stats‚Ä¶</li>
            </ul>
            <div class="mt-5 text-sm text-slate-300">Test mode: use <code>4242 4242 4242 4242</code></div>
          </div>

          <div class="card p-5 mt-6">
            <h3 class="text-lg font-semibold">Become a Captain</h3>
            <p class="text-slate-300 mt-2">Bring your community to the map. Apply with your email and public handle.</p>
            <form id="joinForm" class="mt-3 space-y-2">
              <input name="email" type="email" placeholder="you@example.com" required class="w-full rounded-lg px-3 py-2 bg-white/5 border border-white/10" />
              <input name="handle" placeholder="your-handle" required class="w-full rounded-lg px-3 py-2 bg-white/5 border border-white/10" />
              <input name="country_iso" placeholder="ISO-3 (optional)" class="w-full rounded-lg px-3 py-2 bg-white/5 border border-white/10" />
              <textarea name="message" placeholder="Why you? (optional)" class="w-full rounded-lg px-3 py-2 bg-white/5 border border-white/10"></textarea>
              <button class="bg-white text-black font-semibold px-4 py-2 rounded-xl">Apply</button>
              <div id="joinMsg" class="text-sm text-slate-300"></div>
            </form>
          </div>
        </aside>
      </div>
    </section>

    <section id="how" class="mx-auto max-w-7xl px-6 mt-12 mb-16">
      <div class="card p-6">
        <h2 class="text-2xl font-semibold mb-3">How it works</h2>
        <ol class="list-decimal ml-5 space-y-2 text-slate-200">
          <li>Tap the map to pick a country, or choose from the select.</li>
          <li>Pick an amount (5/20/50/100) or type your own, then hit Donate.</li>
          <li>Pay securely with Stripe (card or Link). We store minimal info.</li>
          <li>Within seconds, the map lights up and the sidebar updates.</li>
        </ol>
      </div>
    </section>
  </main>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black/60 z-40">
    <div class="card w-[560px] max-w-[94vw] p-5">
      <div class="flex items-center justify-between">
        <div class="text-lg font-semibold">Donate to <span id="modalCountry">Croatia</span></div>
        <button id="closeModal" class="px-3 py-1.5 rounded-lg border border-white/10 hover:bg-white/10">Close</button>
      </div>
      <div class="mt-4 space-y-3">
        <div class="flex items-center gap-2">
          <span class="opacity-70">EUR</span>
          <input id="amtModal" type="number" min="1" max="5000" value="20" class="w-32 rounded-lg px-3 py-2 bg-white/5 border border-white/10" />
          <div class="ml-auto flex gap-2">
            <button data-amt="5" class="amt2 px-3 py-1.5 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10">‚Ç¨5</button>
            <button data-amt="20" class="amt2 px-3 py-1.5 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10">‚Ç¨20</button>
            <button data-amt="50" class="amt2 px-3 py-1.5 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10">‚Ç¨50</button>
            <button data-amt="100" class="amt2 px-3 py-1.5 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10">‚Ç¨100</button>
          </div>
        </div>
        <button id="payNow" class="bg-emerald-400 text-black font-semibold px-4 py-2 rounded-xl">Pay with Stripe</button>
        <div class="text-sm text-slate-400">Goes to Stripe Checkout. You can cancel anytime.</div>
      </div>
    </div>
  </div>

  <footer class="mx-auto max-w-7xl px-6 pb-12">
    <div class="mt-10 text-sm text-slate-400">¬© TapTheMap</div>
  </footer>

  <script>
    // ---------- Helpers ----------
    const euro = (x)=> new Intl.NumberFormat('en', { style:'currency', currency:'EUR', maximumFractionDigits:0 }).format(x);
    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));

    // Geo helpers (handle various property names from different GeoJSON sources)
    const isoFrom  = (p) => (p.ADM0_A3 || p.ISO_A3 || p.iso_a3 || p.A3 || p.SOV_A3 || p.id || '').toUpperCase();
    const nameFrom = (p) => (p.NAME_EN || p.ADMIN || p.NAME || p.name || 'Unknown');

    // ---------- Elements ----------
    const mapEl = document.getElementById('map');
    const modal = document.getElementById('modal');
    const modalCountry = document.getElementById('modalCountry');
    const closeModalBtn = document.getElementById('closeModal');
    const openModalBtn = document.getElementById('openModal');
    const payNow = document.getElementById('payNow');
    const amtInput = document.getElementById('otherAmt');
    const amtModal = document.getElementById('amtModal');
    const mapStatus = document.getElementById('mapStatus');
    const todayList = document.getElementById('todayList');
    const countrySelect = document.getElementById('countrySelect');
    const legendEl = document.getElementById('legend');

    // ---------- State ----------
    let totalsByIso = {};       // ISO3 -> total_eur
    let maxTotal = 0;
    let chosen = { country_iso:'HRV', country_name:'Croatia', amount:20, ref:'' };

    // Capture referral from URL (?r=handle) + thank-you toast on ?ok=1
    const __qs = new URLSearchParams(location.search);
    const __ref = (__qs.get('r') || '').replace(/[^a-z0-9_\-\.]/gi, '').slice(0, 64);
    if (__ref) chosen.ref = __ref;
    if (__qs.get('ok') === '1') {
      const el = document.createElement('div');
      el.textContent = 'Hvala! Uplata je pro≈°la.';
      Object.assign(el.style, { position:'fixed', right:'16px', bottom:'16px', background:'#101725', color:'#cfe2ff', border:'1px solid #24314f', padding:'10px 12px', borderRadius:'10px', zIndex:9999 });
      document.body.appendChild(el); setTimeout(()=> el.remove(), 3000);
    }

    // ---------- Map & choropleth ----------
    const map = L.map(mapEl, { worldCopyJump:true, minZoom:2, maxZoom:6, zoomControl:true }).setView([20, 0], 2);
    L.tileLayer('https://cartodb-basemaps-b.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png', { attribution:'¬© OpenStreetMap & CARTO', detectRetina:true, maxZoom:6, minZoom:2 }).addTo(map);
    map.createPane('countries'); map.getPane('countries').style.zIndex = 650;

    // Cheerful vivid palette (low ‚Üí high)
    const VIVID = ['#9be9a8','#6fd3ff','#a78bfa','#ffafcc','#ffd166','#80ed99','#ff6b6b'];
    const baseStyle  = { color:'#0f172a', weight:0.6, fillColor: VIVID[0], fillOpacity:0.80 };
    const hoverStyle = { ...baseStyle, weight:1.6, color:'#ffffff', fillOpacity:0.92 };

    function styleFor(total) {
      if (!maxTotal || !total) return { ...baseStyle, fillColor: VIVID[0] };
      const t = Math.log10((total||0)+1) / Math.log10((maxTotal||0)+1); // 0..1
      const idx = Math.min(VIVID.length-1, Math.max(0, Math.round(t*(VIVID.length-1))));
      return { ...baseStyle, fillColor: VIVID[idx] };
    }

    function renderLegend(){
      if (!legendEl) return;
      legendEl.innerHTML = VIVID.map((c,i)=>
        `<span style="display:inline-flex;align-items:center;gap:6px">
           <span style="width:14px;height:14px;border-radius:3px;background:${c};display:inline-block;border:1px solid rgba(255,255,255,.25)"></span>
           ${i===0 ? 'low' : (i===VIVID.length-1 ? 'high' : '')}
         </span>`
      ).join(' ');
    }

    // Fallback izvori za GeoJSON (rade i kad pojedini CDN ≈°teka)
    const SOURCES = [
      'https://cdn.jsdelivr.net/npm/@geo-maps/countries-land-10m@1.0.1/countries-land-10m.geo.json',
      'https://unpkg.com/@geo-maps/countries-land-10m@1.0.1/countries-land-10m.geo.json',
      'https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson'
    ];

    const layersByIso = new Map();

    async function fetchAny(urls){
      let lastErr;
      for (const u of urls){
        try { const r = await fetch(u, { cache:'no-store' }); if(!r.ok) throw new Error(r.status); return await r.json(); }
        catch(e){ lastErr = e; }
      }
      throw lastErr || new Error('All sources failed');
    }

    // Uƒçitaj svijet + ispuni select + bindaj dogaƒëaje
    fetchAny(SOURCES).then(geo=>{
      mapStatus.textContent = 'World ready ‚úì';

      // select options
      const opts = [];
      (geo.features||[]).forEach(f => {
        const iso = isoFrom(f.properties); const name = nameFrom(f.properties);
        if (iso && name) opts.push([iso,name]);
      });
      opts.sort((a,b)=> a[1].localeCompare(b[1]));
      countrySelect.innerHTML = opts.map(([iso,name])=> `<option value="${iso}|${name}">${name} (${iso})</option>`).join('');
      countrySelect.value = `${chosen.country_iso}|${chosen.country_name}`;

      L.geoJSON(geo, {
        pane:'countries',
        style: () => ({ ...baseStyle }),
        onEachFeature: (f, lyr) => {
          const iso = isoFrom(f.properties);
          const name = nameFrom(f.properties);
          layersByIso.set(iso, lyr);

          const tip = () => {
            const total = totalsByIso[iso] ? Number(totalsByIso[iso]) : 0;
            return total > 0 ? `${name} ¬∑ ${euro(total)}` : name;
          };
          lyr.bindTooltip(tip(), { sticky:true, opacity:0.95 });

          lyr.on({
            mouseover: (e)=>{ e.target.setStyle(hoverStyle); e.target.bringToFront(); map.getContainer().style.cursor='pointer'; },
            mouseout:  (e)=>{ const t = totalsByIso[iso] ? Number(totalsByIso[iso]) : 0; e.target.setStyle(styleFor(t)); map.getContainer().style.cursor=''; },
            click:     (e)=>{
              chosen.country_iso = iso; chosen.country_name = name; modalCountry.textContent = name;
              const b = e.target.getBounds(); if (b && b.isValid()) map.fitBounds(b, { maxZoom:4, padding:[20,20] });
              const val = `${iso}|${name}`; countrySelect.value = val;
              openModal();
            }
          });
        }
      }).addTo(map);

      // start polling after world ready
      refreshStats(true);
      renderLegend();
    }).catch(()=>{
      mapStatus.textContent = 'World failed to load';
    });

    // ---------- UI events ----------
    function openModal(){ modal.classList.remove('hidden'); modalCountry.textContent = chosen.country_name; }
    function closeModal(){ modal.classList.add('hidden'); }

    closeModalBtn.addEventListener('click', closeModal);
    openModalBtn.addEventListener('click', ()=>{
      const v = parseInt(amtInput.value,10); if (v>0) chosen.amount = v;
      openModal();
    });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

    // quick amounts ‚Üí inputs
    document.querySelectorAll('.amt').forEach(b=> b.addEventListener('click', ()=>{ const v = parseInt(b.dataset.amt,10); if(v>0){ amtInput.value = v; } }));
    document.querySelectorAll('.amt2').forEach(b=> b.addEventListener('click', ()=>{ const v = parseInt(b.dataset.amt,10); if(v>0){ amtModal.value = v; } }));

    countrySelect.addEventListener('change', (e)=>{
      const [iso,name] = (e.target.value || '').split('|');
      chosen.country_iso = iso; chosen.country_name = name; modalCountry.textContent = name;
    });

    // ---------- Checkout ----------
    payNow.addEventListener('click', async ()=>{
      try {
        const val = parseInt(amtModal.value || amtInput.value, 10);
        if (val>0) chosen.amount = clamp(val, 1, 5000);
        const res = await fetch('/.netlify/functions/checkout', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(chosen) });
        if (res.status === 503) { alert('Payments are not configured yet. Add STRIPE keys in Netlify ENV.'); return; }
        if (!res.ok) { const t = await res.text(); alert('Checkout error: ' + t); return; }
        const { url } = await res.json(); if (url) location.href = url; else alert('No checkout URL returned.');
      } catch { alert('Network error.'); }
    });

    // ---------- Stats (polling + render) ----------
    async function refreshStats(first=false){
      try{
        const r = await fetch('/.netlify/functions/stats', { cache: 'no-store' });
        if(!r.ok){ throw new Error(await r.text()); }
        const items = await r.json(); // [{ iso, name, total_eur, donors_24h, donors_7d }]

        totalsByIso = {}; maxTotal = 0;
        for(const it of items){
          const iso = (it.iso || it.country_iso || '').toUpperCase();
          const total = Number(it.total_eur || 0);
          totalsByIso[iso] = total;
          if (total > maxTotal) maxTotal = total;
        }

        // repaint fills + tooltips
        layersByIso.forEach((lyr, iso)=>{
          const total = totalsByIso[iso] ? Number(totalsByIso[iso]) : 0;
          lyr.setStyle(styleFor(total));
          const nm = (lyr.feature && lyr.feature.properties) ? (lyr.feature.properties.NAME_EN || lyr.feature.properties.ADMIN || 'Unknown') : iso;
          const tip = total > 0 ? `${nm} ¬∑ ${euro(total)}` : nm;
          lyr.bindTooltip(tip, { sticky:true, opacity:0.95 });
        });

        renderToday(items);
        if(first){ mapStatus.textContent = 'World & stats live ‚úì'; }
      }catch(e){
        console.error('Stats error', e);
        todayList.innerHTML = `<li class="text-slate-400 text-sm">Stats unavailable.</li>`;
        if(first){ mapStatus.textContent = 'World ready (stats unavailable)'; }
      } finally {
        setTimeout(()=>refreshStats(false), 20000);
      }
    }

    function renderToday(items){
      if(!Array.isArray(items) || items.length===0){
        todayList.innerHTML = `<li class="text-slate-400 text-sm">No activity yet. Be the first ‚ú®</li>`;
        return;
      }
      const top = [...items]
        .sort((a,b)=>{
          const d = (b.donors_24h||0) - (a.donors_24h||0);
          if (d!==0) return d;
          return (Number(b.total_eur||0) - Number(a.total_eur||0));
        })
        .slice(0,10);

      todayList.innerHTML = top.map(it=>{
        const iso = (it.iso || it.country_iso || '').toUpperCase();
        const name = it.name || it.country_name || iso;
        const donors = it.donors_24h || 0;
        const total  = Number(it.total_eur || 0);
        return `
          <li class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="inline-flex w-8 h-8 rounded-full bg-emerald-500/10 text-emerald-300 items-center justify-center border border-emerald-400/40 text-sm">${iso}</span>
              <div>
                <div class="font-semibold">${name}</div>
                <div class="text-xs text-slate-400 mini">${donors} donors ¬∑ ${euro(total)} total</div>
              </div>
            </div>
            <div class="text-sm text-slate-300 mini">${euro(total)}</div>
          </li>`;
      }).join('');
    }
  </script>
</body>
</html>
